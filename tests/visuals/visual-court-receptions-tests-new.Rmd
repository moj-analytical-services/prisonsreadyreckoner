---
title: "Testing effect of court receptions"
author: "Alex Dickinson"
date: "09/06/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
```

```{r echo=FALSE}


###-----------------------------------------------------------------------------
# LOAD BACKGROUND VARIABLES FOR PRISONFLOWCAST

### PUT PARAMS HERE
params <- list()


################################################################################
# Model levers and impact dates.
# Levers are intended for use by a package user. The Shiny app will make use
# of defaults only and set reactive values based on either defaults or inputs
# from the Shiny GUI.
################################################################################

# Number of extra police charges
params$lever_police_charges_scenario           <- "central"

# Number of extra court sitting days per month
params$lever_extra_cc_sitting_days             <- 20000 / 12             # [month^-1]
params$lever_extra_cc_sitting_days_impact_date <- "2024-01-01"

# Number of extra prison receptions per band per month
params$lever_extra_inflows_det                 <- c(senband1 = 0, senband2 = 0, senband3 = 0, senband4 = 0)
params$lever_extra_inflows_det_impact_date     <- "2024-01-01"

# Factors for stretching profiles of time served in prison, broken down by sentence band
params$lever_profiles_det_stretch_factors      <- c(senband1 = 1, senband2 = 1, senband3 = 1, senband4 = 1)
params$lever_profiles_det_stretch_impact_date  <- "2024-01-01"

# Recall
params$lever_recall_rate                       <- signif(c(senband1 = 0.234774346793349, senband2 = 0.1003465003465, senband3 = 0.048357569686712, senband4 = 0.0213297380452349), 3)   # 20230505 - Charlotte Wallace - Updated prison projections .msg
params$lever_recall_rate_impact_date           <- "2024-01-01"



################################################################################
# General parameters.
# General parameters are intended for use by a package user and the Shiny app.
# A user may wish to change these but they will be fixed for individual
# releases of the Shiny app.
################################################################################

# Expected initial dates in various data files. The forecast will start from the
# last consistent date.
params$start_date$police_charges_cc  <- "2022-11-01"    # First month of the forecast. Used for verifying inputs.
params$start_date$police_charges_mc  <- "2022-12-01"
params$start_date$inflows_det        <- "2023-03-31"
params$start_date$recall_rate        <- "2023-03-01"
params$start_date$cc_files           <- "2022-11-01"


params$projection_length_months <- 49         # To March 2027. '20230525 - To Ceri Cooper - Actions from our ready reckoner meeting just now_.msg'


# Police charge parameters
# Magistrates' courts
params$police_charges_mc_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/020623_mags_sensitivity_output.xlsx"
params$police_charges_mc_scenarios <- list(central = "apr23_central",
                                           ramp_12m = "apr23_central_12m",
                                           ramp_36m = "apr23_central_36m",
                                           ramp_48m = "apr23_central_48m"
)
params$police_charges_mc_sheet <- "020623_mags_sensitivity_output-"


# Crown Court
params$police_charges_cc_files <- list(central = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_for_ready_reckoner.csv", # Records the total number of Crown Court receipts used as a baseline in the April 2023 projections. Includes background values from various sources, and an increase in charge numbers over a 24-month period. It has non-zero values throughout.
                                       ramp_12m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_12m_ramp_for_ready_reckoner.csv", # Records how Crown Court receipts would change if police charge numbers were increased over a 12-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
                                       ramp_36m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_36m_ramp_for_ready_reckoner.csv", # Records how Crown Court receipts would change if police charge numbers were increased over a 36-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
                                       ramp_48m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_48m_ramp_for_ready_reckoner.csv" # Records how Crown Court receipts would change if police charge numbers were increased over a 48-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
)   # '20230525 - David Verry - RE_ Next steps on the CJS ready reckoner.eml'

# Table from Chun-Yee for converting Crown Court police charge tables
params$police_charges_cc_route_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/routes.csv"   # '20230518 - Chun-yee Cheng - cjst pre-covid route distribution.msg'  


# Crown Court parameters
# Input paths
params$cc_output_file          <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/crown-output-apr23_s4.csv"   # '20230502 - Chun-yee Cheng - RE_ Testing our assumptions with a second Crown Court scenario_.msg'
params$cc_capacity_file        <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/sd_htpsd_adjusted_apr23_s4.csv"   # '20230502 - Chun-yee Cheng - RE_ Testing our assumptions with a second Crown Court scenario_.msg'

# Paths to parameter tables
params$ringfenced_lookup_file  <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/ringfenced-lookup-20230502-shiny-v0.0.0-OFFICIAL.csv"


# Sentencing parameters
# Remand rates. FYI, the Prisons team provided an intercept but this is not
# relevant for marginal changes. The following co-efficients were derived from
# backlog volumes calibrated to match HMCTS outstanding caseload but, for
# simplicity, we are applying them to unadjusted changes in non-ringfenced
# disposal volumes.
params$remand_rates <- tibble::tribble(
  ~receipt_type_desc, ~remand_rate,
  "ind",                     0.580,
  "tew",                     0.277,
  "app",                         0,
  "sent",                        0)   # 20230503 - Charlotte Wallace - RE_ Gender split and remand ratio_.msg

params$sentencing_rates_file  <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/reception-rates-20230502-shiny-v0.0.0-OFFICIAL.csv"


# Prison and licence parameters
params$prison_inflows_file   <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/detailed_apr23_s4_apr23_flat_3m_linear_6m_msim_EDS_change_os_adj_DandS_3m_current_6m_avg_longterm_230426_150555.xlsx"   # '20230505 - Charlotte Wallace - Updated prison projections .msg'
params$profiles_file         <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/profiles-det-20230502-shiny-v0.0.0-OFFICIAL.csv"

# Recall/licence variables
# Put back to previous version so recall rates are fixed values rather than time series
params$recall_file           <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/recall_excl_PSS_output_apr23_s4_apr23_flat_3m_linear_6m_msim_EDS_change_os_adj_DandS_3m_current_6m_avg_longterm_230426_150555.xlsx"   # '20230505 - Charlotte Wallace - Updated prison projections .msg'
#params$licence_times_file    <- "s3://alpha-probation-forecasting-data/Licence/time_spent_on_licence/average_time_on_licence_excl_pss_2023-02-28.csv"   # '20230419 - Danielle Kelly - RE_ Licence and recall parameters_.msg'
params$licence_profiles_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/adjusted_license_profile.csv"   # '20230601 - Jordan Carroll - RE_ Your licence profiles_.msg'



# Mean monthly inflow of indeterminate prisoners, taken from OMSQ. We assume
# that indeterminates are never released
params$inflows_indet_mean   <- 299 / 12   # OMSQ Oct-Dec 2022, Table 2.5a, last four quarters


# Gender splits
params$gender_splits_file      <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/gender-splits-20230502-shiny-v0.0.0-OFFICIAL.csv"

### Set up parameters in correct format ###
params <- format_params(params)

### Load datasets that are fixed throughout the model ###
loaded_datasets_list             <- load_datasets(params)

# cc_receipts_delta_loaded_list    <- loaded_datasets_list$cc_receipts_delta_loaded_list
# mc_disposals_delta_loaded_list   <- loaded_datasets_list$mc_disposals_delta_loaded_list
# cc_output_loaded                 <- loaded_datasets_list$cc_output
# cc_capacity_loaded               <- loaded_datasets_list$cc_capacity
sentencing_rates_loaded          <- loaded_datasets_list$sentencing_rates
inflows_det_loaded               <- loaded_datasets_list$inflows_det
profiles_det_loaded              <- loaded_datasets_list$profiles_det
nomis_out_delius_in_ratio        <- loaded_datasets_list$nomis_out_delius_in_ratio
#average_time_on_licence_excl_ps  <- loaded_datasets_list$average_time_on_licence_excl_ps
profiles_lic                     <- loaded_datasets_list$profiles_lic
#licence_profile_adjustments_exc  <- loaded_datasets_list$licence_profile_adjustments_exc
recall_rate_exclPSS              <- loaded_datasets_list$recall_rate_exclPSS
average_time_on_recall           <- loaded_datasets_list$average_time_on_recall
recall_profile_adjustments       <- loaded_datasets_list$recall_profile_adjustments
gender_splits                    <- loaded_datasets_list$gender_splits


# Make profiles of time on recall.
recall_time     <- multiply_two_named_vectors(average_time_on_recall, recall_profile_adjustments, arguments_to_keep = c("senband1", "senband2", "senband3", "senband4"))
profiles_recall <- make_lag_filters(recall_time)


pop_baseline <- run_baseline(params, inflows_det_loaded, profiles_det_loaded,
                             nomis_out_delius_in_ratio, profiles_lic, recall_rate_exclPSS, profiles_recall)


#-------------------------------------------------------------------------------


format_charlotte_cc_disposals <- function(cc_disposals_charlotte_loaded, forecast_start_date, forecast_end_date) {
  
  print("cc_disposals_charlotte_loaded")
  print(cc_disposals_charlotte_loaded)
  
  
  
  # Sum over receipt_type_desc as our linear model is based on route only.
  cc_disposals_charlotte <- tidyr::pivot_longer(cc_disposals_charlotte_loaded, -c("date_value"), names_to = "route", values_to = "n_disposals") %>%
    dplyr::mutate(date = as.Date(date_value), .keep = "unused") %>%
    dplyr::mutate(route = dplyr::if_else(route == "0_app_app", "app", route),
                  route = dplyr::if_else(route == "0_ind_e_other", "e_other", route),
                  route = dplyr::if_else(route == "0_ind_effective", "effective", route),
                  route = dplyr::if_else(route == "0_ind_egp", "egp", route),
                  route = dplyr::if_else(route == "0_ind_gp_cracked", "gp_cracked", route),
                  route = dplyr::if_else(route == "0_ind_l_other", "l_other", route),
                  route = dplyr::if_else(route == "0_ind_lgp", "lgp", route),
                  route = dplyr::if_else(route == "0_ind_other_cracked", "other_cracked", route),
                  route = dplyr::if_else(route == "0_sent_sent", "app", route),
                  route = dplyr::if_else(route == "0_tew_e_other", "e_other", route),
                  route = dplyr::if_else(route == "0_tew_effective", "effective", route),
                  route = dplyr::if_else(route == "0_tew_egp", "egp", route),
                  route = dplyr::if_else(route == "0_tew_gp_cracked", "gp_cracked", route),
                  route = dplyr::if_else(route == "0_tew_l_other", "l_other", route),
                  route = dplyr::if_else(route == "0_tew_lgp", "lgp", route),
                  route = dplyr::if_else(route == "0_tew_other_cracked", "other_cracked", route),
                  route = dplyr::if_else(route == "1_ind_e_other", "e_other", route),
                  route = dplyr::if_else(route == "1_ind_effective", "effective", route),
                  route = dplyr::if_else(route == "1_ind_egp", "app", route),
                  route = dplyr::if_else(route == "1_ind_gp_cracked", "gp_cracked", route),
                  route = dplyr::if_else(route == "1_ind_l_other", "l_other", route),
                  route = dplyr::if_else(route == "1_ind_lgp", "lgp", route),
                  route = dplyr::if_else(route == "1_ind_other_cracked", "other_cracked", route),
                  route = dplyr::if_else(route == "1_sent_sent", "app", route),
                  route = dplyr::if_else(route == "1_tew_e_other", "e_other", route),
                  route = dplyr::if_else(route == "1_tew_effective", "effective", route),
                  route = dplyr::if_else(route == "1_tew_egp", "egp", route),
                  route = dplyr::if_else(route == "1_tew_gp_cracked", "gp_cracked", route),
                  route = dplyr::if_else(route == "1_tew_l_other", "l_other", route),
                  route = dplyr::if_else(route == "1_tew_lgp", "lgp", route),
                  route = dplyr::if_else(route == "1_tew_other_cracked", "other_cracked", route)
    ) %>%
    dplyr::mutate(disposal_type = paste0("cc_", route)) %>%
    dplyr::group_by(date, disposal_type) %>%
    dplyr::summarise(n_disposals = sum(n_disposals, na.rm = TRUE), .groups = "drop")
  
  cc_disposals_charlotte <- cc_disposals_charlotte %>%
    dplyr::mutate(date = lubridate::floor_date(date, "month")) %>% 
    dplyr::filter(date >= forecast_start_date, date <= forecast_end_date)
  
  if (min(cc_disposals_charlotte$date) != forecast_start_date || max(cc_disposals_charlotte$date) != forecast_end_date)
    stop("Input file did not cover the full date range requested. Dates must exist for the interval, ", forecast_start_date, ", to ", forecast_end_date, ".")
  
  return(cc_disposals_charlotte)
  
}


format_charlotte_mc_disposals <- function(mc_disposals_charlotte_loaded, forecast_start_date, forecast_end_date) {
  
  mc_disposals_charlotte <- mc_disposals_charlotte_loaded %>%
    dplyr::select(-c("disposals_forecast_23k")) %>%
    dplyr::mutate(date = as.Date(year_month, "%d/%m/%Y"),
                  disposal_type = type,
                  n_disposals = disposals_forecast,
                  .keep = "unused") %>%
    dplyr::mutate(disposal_type = dplyr::if_else(disposal_type == "Indictable", "mc_ind", disposal_type),
                  disposal_type = dplyr::if_else(disposal_type == "Summary Motoring - other", "mc_sm", disposal_type),
                  disposal_type = dplyr::if_else(disposal_type == "Summary Non-motoring - other", "mc_snm", disposal_type),
                  disposal_type = dplyr::if_else(disposal_type == "Either Way", "mc_tew", disposal_type))
  
  mc_disposals_charlotte <- mc_disposals_charlotte %>%
    dplyr::mutate(date = lubridate::floor_date(date, "month")) %>% 
    dplyr::filter(date >= forecast_start_date, date <= forecast_end_date)
  
  if (min(mc_disposals_charlotte$date) != forecast_start_date || max(mc_disposals_charlotte$date) != forecast_end_date)
    stop("Input file did not cover the full date range requested. Dates must exist for the interval, ", forecast_start_date, ", to ", forecast_end_date, ".")
  
}


calculate_charlotte_disposals_delta <- function(disposals_charlotte, disposals_charlotte_baseline) {
  disposals_charlotte_delta <- disposals_charlotte %>%
    dplyr::left_join(disposals_charlotte_baseline, by = c("date", "disposal_type")) %>%
    dplyr::mutate(n_disposals_delta = n_disposals.x - n_disposals.y, .keep = "unused")
  
}


run_prisons_module_charlotte_inflows <- function(params, inflows_det_adj, profiles_det_loaded) {
  
  # LEVER: Add delta from extra inflows lever to other inflows
  inflows_det_levered <- add_inflows_det_delta_lever(inflows_det_adj, params$lever_extra_inflows_det, params$lever_extra_inflows_det_impact_date)
  
  # LEVER: Change distribution of time served by sentence band
  #t0_stretch <- Sys.time()
  profiles_det_levered <- stretch_profiles(profiles_det_loaded, params$lever_profiles_det_stretch_factors, params$lever_profiles_det_stretch_factor_min, params$lever_profiles_det_stretch_factor_max, params$projection_length_months)
  profiles_det_stretch_impact_date_levered <- params$lever_profiles_det_stretch_impact_date
  #print(paste0("stretch_profiles took ", Sys.time() - t0_stretch, " seconds"))
  
  prison_det_outputs <- run_prison_determinate_module(inflows_det_levered, profiles_det_stretch_impact_date_levered, profiles_det_levered)
  outflows_det     <- prison_det_outputs$outflows_det
  pop_det          <- prison_det_outputs$pop_det
  
  month_names        <- names(dplyr::select(inflows_det_loaded, -c("senband")))
  pop_indet          <- run_prison_indeterminate_module(month_names, params$inflows_indet_mean)
  
  
  # LEVER: Set recall rates
  recall_rate_levered             <- params$lever_recall_rate
  recall_rate_impact_date_levered <- params$lever_recall_rate_impact_date
  
  pop_recall         <- run_prison_recall_module(outflows_det, nomis_out_delius_in_ratio, profiles_lic,
                                                 recall_rate_exclPSS, recall_rate_levered, recall_rate_impact_date_levered, profiles_recall)
  
  print("pop_det")
  View(pop_det)
  
  pop_det <- pop_det %>%
    dplyr::mutate(run = "scenario", casetype = "determinate")
  
  print("pop_det")
  View(pop_det)
  
  return(pop_det)
}


# Load Crown Court disposals data from Charlotte

charlotte_baseline_cc_disposals_file <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4.xlsx"

charlotte_baseline_cc_disposals_loaded <- import_s3_file(charlotte_baseline_cc_disposals_file, sheet = "disp_plea_impactrr_out_apr23_s4")

charlotte_baseline_cc_disposals <- format_charlotte_cc_disposals(charlotte_baseline_cc_disposals_loaded, params$forecast_start_date, params$forecast_end_date)



charlotte_low_cc_disposals_file <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4_RR_test_min.xlsx"

charlotte_low_cc_disposals_loaded <- import_s3_file(charlotte_low_cc_disposals_file, sheet = "disp_plea_impactrr_out_apr23_s4")

charlotte_low_cc_disposals <- format_charlotte_cc_disposals(charlotte_low_cc_disposals_loaded, params$forecast_start_date, params$forecast_end_date)

charlotte_low_cc_disposals_delta <- calculate_charlotte_disposals_delta(charlotte_low_cc_disposals, charlotte_baseline_cc_disposals)



charlotte_high_cc_disposals_file <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4_RR_test_max.xlsx"

charlotte_high_cc_disposals_loaded <- import_s3_file(charlotte_high_cc_disposals_file, sheet = "disp_plea_impactrr_out_apr23_s4")

charlotte_high_cc_disposals <- format_charlotte_cc_disposals(charlotte_high_cc_disposals_loaded, params$forecast_start_date, params$forecast_end_date)

charlotte_high_cc_disposals_delta <- calculate_charlotte_disposals_delta(charlotte_high_cc_disposals, charlotte_baseline_cc_disposals)




# Load magistrates' court disposals data from Charlotte

charlotte_baseline_mc_disposals_file <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_0901/mags_projections/projections_from_mags_model_built_2022_02/2022_06/apr23_test_output_mags_med.csv"

charlotte_baseline_mc_disposals_loaded <- import_s3_file(charlotte_baseline_mc_disposals_file)

charlotte_baseline_mc_disposals <- format_charlotte_mc_disposals(charlotte_baseline_mc_disposals_loaded, params$forecast_start_date, params$forecast_end_date)



charlotte_low_mc_disposals_file <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_0901/mags_projections/projections_from_mags_model_built_2022_02/2022_06/apr23_test_output_mags_med_RR_test_min.csv"

charlotte_low_mc_disposals_loaded <- import_s3_file(charlotte_low_mc_disposals_file)

charlotte_low_mc_disposals <- format_charlotte_mc_disposals(charlotte_low_mc_disposals_loaded, params$forecast_start_date, params$forecast_end_date)

charlotte_low_mc_disposals_delta <- calculate_charlotte_disposals_delta(charlotte_low_mc_disposals, charlotte_baseline_mc_disposals)



charlotte_high_mc_disposals_file <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_0901/mags_projections/projections_from_mags_model_built_2022_02/2022_06/apr23_test_output_mags_med_RR_test_max.csv"

charlotte_high_mc_disposals_loaded <- import_s3_file(charlotte_high_mc_disposals_file)

charlotte_high_mc_disposals <- format_charlotte_mc_disposals(charlotte_high_mc_disposals_loaded)

charlotte_high_mc_disposals_delta <- calculate_charlotte_disposals_delta(charlotte_high_mc_disposals, charlotte_baseline_mc_disposals)




# Combine Crown Court disposals with magistrates' court disposals.
charlotte_high_disposals_delta <- dplyr::bind_rows(charlotte_high_cc_disposals_delta, charlotte_high_mc_disposals_delta)

inflows_det_delta_high <- calculate_inflows_det_delta_SUB(charlotte_high_disposals_delta, sentencing_rates_loaded)



# Run Charlotte's court disposals through the relevant prisonflowcast functions

# Add Charlotte's delta inflows to the background inflows
inflows_det_high_adj <- add_inflows_det_delta_courts(inflows_det_loaded, inflows_det_delta_high)

pop_det_high <- run_prisons_module_charlotte_inflows(params, inflows_det_high_adj, profiles_det_loaded) 

View(pop_det_high)



pop_det_high
pop_det_baseline



# Combine with the baseline and pivot for ease of splitting by gender.
pop_combined <- rbind(pop_baseline, pop_det_high) %>%
  tidyr::pivot_longer(-c("run", "casetype", "senband"), names_to = "date", values_to = "population") %>%
  dplyr::mutate(date = as.Date(date))

# Add splits by gender
pop_combined <- split_populations_by_gender(pop_combined, gender_splits)




pop_det_high_long <- pop_det_high %>%
  tidyr::pivot_longer(-c("senband"), names_to = "date", values_to = "volume") %>%
  dplyr::arrange(date, senband)


pop_det_baseline_long <- pop_baseline[pop_baseline$casetype %in% c('determinate'), ] %>%
  dplyr::select(-c("run", "casetype")) %>%
  tidyr::pivot_longer(-c("senband"), names_to = "date", values_to = "volume") %>%
  dplyr::arrange(date, senband)


pop_det_high_long
pop_det_baseline_long









```