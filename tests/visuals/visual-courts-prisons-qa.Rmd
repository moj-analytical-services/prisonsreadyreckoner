---
title: "Testing performance of `prisonsreadyreckoner` against CJS Modelling team results"
author: "Alex Dickinson"
date: "24/07/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
```


```{r echo=FALSE}

silence_botor()

###-----------------------------------------------------------------------------
# LOAD BACKGROUND VARIABLES FOR prisonsreadyreckoner

params <- list()


################################################################################
# Model levers and impact dates.
# Levers are intended for use by a package user. The Shiny app will make use
# of defaults only and set reactive values based on either defaults or inputs
# from the Shiny GUI.
################################################################################

# Number of extra police charges
params$lever_police_charges_scenario           <- "central"

# Number of extra court sitting days per month
params$lever_extra_cc_sitting_days             <- 0 / 12             # [month^-1]
params$lever_extra_cc_sitting_days_impact_date <- "2024-01-01"

# Number of extra prison receptions per band per month
params$lever_extra_inflows_det                 <- c(senband1 = 0, senband2 = 0, senband3 = 0, senband4 = 0)
params$lever_extra_inflows_det_impact_date     <- "2024-01-01"

# Factors for stretching profiles of time served in prison, broken down by sentence band
params$lever_profiles_det_stretch_factors      <- c(senband1 = 1, senband2 = 1, senband3 = 1, senband4 = 1)
params$lever_profiles_det_stretch_impact_date  <- "2024-01-01"

# Recall
params$lever_recall_rate                       <- signif(c(senband1 = 0.234774346793349, senband2 = 0.1003465003465, senband3 = 0.048357569686712, senband4 = 0.0213297380452349), 3)   # 20230505 - Charlotte Wallace - Updated prison projections .msg
params$lever_recall_rate_impact_date           <- "2024-01-01"



################################################################################
# General parameters.
# General parameters are intended for use by a package user and the Shiny app.
# A user may wish to change these but they will be fixed for individual
# releases of the Shiny app.
################################################################################

# Expected initial dates in various data files. The forecast will start from the
# last consistent date.
params$start_date$police_charges_cc  <- "2022-11-01"    # First month of the forecast. Used for verifying inputs.
params$start_date$police_charges_mc  <- "2022-12-01"
params$start_date$inflows_det        <- "2023-03-31"
params$start_date$recall_rate        <- "2023-03-01"
params$start_date$cc_files           <- "2022-11-01"


params$projection_length_months <- 49         # To March 2027. '20230525 - To Ceri Cooper - Actions from our ready reckoner meeting just now_.msg'


# Police charge parameters
# Magistrates' courts
params$police_charges_mc_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/020623_mags_sensitivity_output.xlsx"
params$police_charges_mc_scenarios <- list(central = "apr23_central",
                                           ramp_12m = "apr23_central_12m",
                                           ramp_36m = "apr23_central_36m",
                                           ramp_48m = "apr23_central_48m"
)
params$police_charges_mc_sheet <- "020623_mags_sensitivity_output-"

# Crown Court
params$police_charges_cc_files <- list(central = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_for_ready_reckoner.csv", # Records the total number of Crown Court receipts used as a baseline in the April 2023 projections. Includes background values from various sources, and an increase in charge numbers over a 24-month period. It has non-zero values throughout.
                                    ramp_12m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_12m_ramp_for_ready_reckoner.csv", # Records how Crown Court receipts would change if police charge numbers were increased over a 12-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
                                    ramp_36m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_36m_ramp_for_ready_reckoner.csv", # Records how Crown Court receipts would change if police charge numbers were increased over a 36-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
                                    ramp_48m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_48m_ramp_for_ready_reckoner.csv" # Records how Crown Court receipts would change if police charge numbers were increased over a 48-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
)   # '20230525 - David Verry - RE_ Next steps on the CJS ready reckoner.eml'

# Table from Chun-Yee for converting Crown Court police charge tables
params$police_charges_cc_route_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/routes.csv"   # '20230518 - Chun-yee Cheng - cjst pre-covid route distribution.msg'  


# Crown Court parameters
# Input paths
params$cc_output_file          <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/crown-output-apr23_s4.csv"   # '20230502 - Chun-yee Cheng - RE_ Testing our assumptions with a second Crown Court scenario_.msg'
params$cc_capacity_file        <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/sd_htpsd_adjusted_apr23_s4.csv"   # '20230502 - Chun-yee Cheng - RE_ Testing our assumptions with a second Crown Court scenario_.msg'

# Paths to parameter tables
params$ringfenced_lookup_file  <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/ringfenced-lookup-20230502-shiny-v0.0.0-OFFICIAL.csv"


# Sentencing parameters
# Remand rates.
# # FYI, the Prisons team provided an intercept but this is not relevant for
# # marginal changes. The following co-efficients were derived from backlog
# # volumes calibrated to match HMCTS outstanding caseload but, for simplicity,
# # we are applying them to unadjusted changes in non-ringfenced disposal
# # volumes.
# params$remand_rates <- tibble::tribble(
#   ~receipt_type_desc, ~remand_rate,
#   "ind",                     0.580,
#   "tew",                     0.277,
#   "app",                         0,
#   "sent",                        0)   # '20230503 - Charlotte Wallace - RE_ Gender split and remand ratio_.msg'
params$remand_rates <- c(receipts = 0.187429985453694, 
                        disposals = 0.475353729743915)   # '20230712 - To Jordan Carroll - RE_ Remand model comparison.msg'
params$no_bail_rate <- 0.2                               # '20230705 - Jordan Carroll - RE_ Sitting Day Remand Impact Method.msg'
params$ctl          <- 6                                 # [months] '20230705 - Jordan Carroll - RE_ Sitting Day Remand Impact Method.msg'
params$mc_remand_lookup <- tibble::tribble(
  ~disposal_type, ~remanded,
  "mc_ind",       TRUE,
  "mc_tew",       TRUE,
  "mc_sm",        FALSE,
  "mc_snm",       FALSE)   # '20230705 - Jordan Carroll - RE_ Sitting Day Remand Impact Method.msg'

params$sentencing_rates_file  <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/reception-rates-20230502-shiny-v0.0.0-OFFICIAL.csv"


# Prison and licence parameters
params$prison_inflows_file   <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/detailed_apr23_s4_apr23_flat_3m_linear_6m_msim_EDS_change_os_adj_DandS_3m_current_6m_avg_longterm_230426_150555.xlsx"   # '20230505 - Charlotte Wallace - Updated prison projections .msg'
params$profiles_file         <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/profiles-det-20230502-shiny-v0.0.0-OFFICIAL.csv"

# Recall/licence variables
# Put back to previous version so recall rates are fixed values rather than time series
params$recall_file           <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/recall_excl_PSS_output_apr23_s4_apr23_flat_3m_linear_6m_msim_EDS_change_os_adj_DandS_3m_current_6m_avg_longterm_230426_150555.xlsx"   # '20230505 - Charlotte Wallace - Updated prison projections .msg'
#params$licence_times_file    <- "s3://alpha-probation-forecasting-data/Licence/time_spent_on_licence/average_time_on_licence_excl_pss_2023-02-28.csv"   # '20230419 - Danielle Kelly - RE_ Licence and recall parameters_.msg'
params$licence_profiles_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/adjusted_license_profile.csv"   # '20230601 - Jordan Carroll - RE_ Your licence profiles_.msg'



# Mean monthly inflow of indeterminate prisoners, taken from OMSQ. We assume
# that indeterminates are never released
params$inflows_indet_mean   <- 299 / 12   # OMSQ Oct-Dec 2022, Table 2.5a, last four quarters


# Gender splits
params$gender_splits_file      <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/gender-splits-20230502-shiny-v0.0.0-OFFICIAL.csv"

### Set up parameters in correct format ###
params <- format_params(params)

### Load datasets that are fixed throughout the model ###
loaded_datasets_list             <- load_datasets(params)

# cc_receipts_delta_loaded_list    <- loaded_datasets_list$cc_receipts_delta_loaded_list
# mc_disposals_delta_loaded_list   <- loaded_datasets_list$mc_disposals_delta_loaded_list
# cc_output_loaded                 <- loaded_datasets_list$cc_output
# cc_capacity_loaded               <- loaded_datasets_list$cc_capacity
sentencing_rates_loaded          <- loaded_datasets_list$sentencing_rates
inflows_det_loaded               <- loaded_datasets_list$inflows_det
profiles_det_loaded              <- loaded_datasets_list$profiles_det
nomis_out_delius_in_ratio        <- loaded_datasets_list$nomis_out_delius_in_ratio
profiles_lic                     <- loaded_datasets_list$profiles_lic
recall_rate_exclPSS              <- loaded_datasets_list$recall_rate_exclPSS
average_time_on_recall           <- loaded_datasets_list$average_time_on_recall
recall_profile_adjustments       <- loaded_datasets_list$recall_profile_adjustments
gender_splits                    <- loaded_datasets_list$gender_splits


# Make profiles of time on recall.
recall_time     <- multiply_two_named_vectors(average_time_on_recall, recall_profile_adjustments, arguments_to_keep = c("senband1", "senband2", "senband3", "senband4"))
profiles_recall <- make_lag_filters(recall_time)

```


```{r echo=FALSE}

format_charlotte_cc_disposals <- function(cc_disposals_charlotte_loaded, forecast_start_date, forecast_end_date, flag) {
  
  # Sum over receipt_type_desc as our linear model is based on route only.
  cc_disposals_charlotte <- tidyr::pivot_longer(cc_disposals_charlotte_loaded, -c("date_value"), names_to = "route", values_to = "n_disposals") %>%
    dplyr::mutate(date = as.Date(date_value), .keep = "unused") %>%
    dplyr::mutate(route = dplyr::if_else(route == "0_app_app", "app", route),
                  route = dplyr::if_else(route == "0_ind_e_other", "e_other", route),
                  route = dplyr::if_else(route == "0_ind_effective", "effective", route),
                  route = dplyr::if_else(route == "0_ind_egp", "egp", route),
                  route = dplyr::if_else(route == "0_ind_gp_cracked", "gp_cracked", route),
                  route = dplyr::if_else(route == "0_ind_l_other", "l_other", route),
                  route = dplyr::if_else(route == "0_ind_lgp", "lgp", route),
                  route = dplyr::if_else(route == "0_ind_other_cracked", "other_cracked", route),
                  route = dplyr::if_else(route == "0_sent_sent", "sent", route),
                  route = dplyr::if_else(route == "0_tew_e_other", "e_other", route),
                  route = dplyr::if_else(route == "0_tew_effective", "effective", route),
                  route = dplyr::if_else(route == "0_tew_egp", "egp", route),
                  route = dplyr::if_else(route == "0_tew_gp_cracked", "gp_cracked", route),
                  route = dplyr::if_else(route == "0_tew_l_other", "l_other", route),
                  route = dplyr::if_else(route == "0_tew_lgp", "lgp", route),
                  route = dplyr::if_else(route == "0_tew_other_cracked", "other_cracked", route)
    )
  
  
  if (flag == "all") {
    cc_disposals_charlotte <- cc_disposals_charlotte %>%
      dplyr::mutate(route = dplyr::if_else(route == "1_ind_e_other", "e_other", route),
                    route = dplyr::if_else(route == "1_ind_effective", "effective", route),
                    route = dplyr::if_else(route == "1_ind_egp", "egp", route),
                    route = dplyr::if_else(route == "1_ind_gp_cracked", "gp_cracked", route),
                    route = dplyr::if_else(route == "1_ind_l_other", "l_other", route),
                    route = dplyr::if_else(route == "1_ind_lgp", "lgp", route),
                    route = dplyr::if_else(route == "1_ind_other_cracked", "other_cracked", route),
                    route = dplyr::if_else(route == "1_sent_sent", "sent", route),
                    route = dplyr::if_else(route == "1_tew_e_other", "e_other", route),
                    route = dplyr::if_else(route == "1_tew_effective", "effective", route),
                    route = dplyr::if_else(route == "1_tew_egp", "egp", route),
                    route = dplyr::if_else(route == "1_tew_gp_cracked", "gp_cracked", route),
                    route = dplyr::if_else(route == "1_tew_l_other", "l_other", route),
                    route = dplyr::if_else(route == "1_tew_lgp", "lgp", route),
                    route = dplyr::if_else(route == "1_tew_other_cracked", "other_cracked", route)
      )
  }
  
  
  cc_disposals_charlotte <- cc_disposals_charlotte %>%
    dplyr::mutate(disposal_type = paste0("cc_", route)) %>%
    dplyr::group_by(date, disposal_type) %>%
    dplyr::summarise(n_disposals = sum(n_disposals, na.rm = TRUE), .groups = "drop")
  
  cc_disposals_charlotte <- cc_disposals_charlotte %>%
    dplyr::mutate(date = lubridate::floor_date(date, "month")) %>% 
    dplyr::filter(date >= forecast_start_date, date <= forecast_end_date)
  
  if (min(cc_disposals_charlotte$date) != forecast_start_date || max(cc_disposals_charlotte$date) != forecast_end_date)
    stop("Input file did not cover the full date range requested. Dates must exist for the interval, ", forecast_start_date, ", to ", forecast_end_date, ".")
  
  return(cc_disposals_charlotte)
  
}


format_charlotte_mc_disposals <- function(mc_disposals_charlotte_loaded, forecast_start_date, forecast_end_date) {
  
  mc_disposals_charlotte <- mc_disposals_charlotte_loaded %>%
    dplyr::select(-c("disposals_forecast_23k")) %>%
    dplyr::mutate(date = as.Date(year_month, "%d/%m/%Y"),
                  disposal_type = type,
                  n_disposals = disposals_forecast,
                  .keep = "unused") %>%
    dplyr::mutate(disposal_type = dplyr::if_else(disposal_type == "Indictable", "mc_ind", disposal_type),
                  disposal_type = dplyr::if_else(disposal_type == "Summary Motoring - other", "mc_sm", disposal_type),
                  disposal_type = dplyr::if_else(disposal_type == "Summary Non-motoring - other", "mc_snm", disposal_type),
                  disposal_type = dplyr::if_else(disposal_type == "Either Way", "mc_tew", disposal_type))
  
  mc_disposals_charlotte <- mc_disposals_charlotte %>%
    dplyr::mutate(date = lubridate::floor_date(date, "month")) %>% 
    dplyr::filter(date >= forecast_start_date, date <= forecast_end_date)
  
  if (min(mc_disposals_charlotte$date) != forecast_start_date || max(mc_disposals_charlotte$date) != forecast_end_date)
    stop("Input file did not cover the full date range requested. Dates must exist for the interval, ", forecast_start_date, ", to ", forecast_end_date, ".")
  
  return(mc_disposals_charlotte)
}


calculate_charlotte_disposals_delta <- function(disposals_charlotte, disposals_charlotte_baseline) {
  
  disposals_charlotte_delta <- disposals_charlotte %>%
    dplyr::left_join(disposals_charlotte_baseline, by = c("date", "disposal_type")) %>%
    dplyr::mutate(n_disposals_delta = n_disposals.x - n_disposals.y, .keep = "unused")
  
}


run_prisons_module_charlotte_inflows <- function(params, inflows_det_adj, profiles_det_loaded) {
  
  # LEVER: Add delta from extra inflows lever to other inflows
  inflows_det_levered <- add_inflows_det_delta_lever(inflows_det_adj, params$lever_extra_inflows_det, params$lever_extra_inflows_det_impact_date)
  
  # LEVER: Change distribution of time served by sentence band
  #t0_stretch <- Sys.time()
  profiles_det_levered <- stretch_profiles(profiles_det_loaded, params$lever_profiles_det_stretch_factors, params$lever_profiles_det_stretch_factor_min, params$lever_profiles_det_stretch_factor_max, params$projection_length_months)
  profiles_det_stretch_impact_date_levered <- params$lever_profiles_det_stretch_impact_date
  #print(paste0("stretch_profiles took ", Sys.time() - t0_stretch, " seconds"))
  
  prison_det_outputs <- run_prison_determinate_module(inflows_det_levered, profiles_det_stretch_impact_date_levered, profiles_det_levered)
    outflows_det     <- prison_det_outputs$outflows_det
    pop_det          <- prison_det_outputs$pop_det
  
  pop_det <- pop_det %>%
    dplyr::mutate(run = "scenario", casetype = "determinate")
  
  return(pop_det)
}



### Functions for formatting Charlotte's population data

format_charlotte_population_data <- function(target_pop_det_loaded) {
  
  target_pop_det_formatted <- target_pop_det_loaded %>%
    dplyr::select(c("RR_test_high_disposals...2", "RR_test_low_disposals...3", "sensitivity_baseline_uncalib...4", "date")) %>%
    dplyr::rename(cjst_high_pop = RR_test_high_disposals...2,
                  cjst_low_pop = RR_test_low_disposals...3,
                  cjst_central_pop = sensitivity_baseline_uncalib...4) %>%
    dplyr::mutate(
      cjst_high_pop_diff = cjst_high_pop - cjst_central_pop,
      cjst_low_pop_diff = cjst_low_pop - cjst_central_pop
    )
  
  return(target_pop_det_formatted = target_pop_det_formatted)
  
}

```


<!-- ## Aim -->

<!-- We aim to demonstrate that the `prisonsreadyreckoner` functions for sentencing and prison flows produce comparable forecasts of prison population as the  -->

<!-- * our model functions for sentencing and prison flows are driven with the same court disposals  -->

<!-- we get comparable forecasts of prison population. -->


<!-- ## Method -->

<!-- Example determinate data from the December 2022 prison projection were obtained -->
<!-- from Charlotte Wallace and pivoted to generate time series of inflows, outflows -->
<!-- and popuation. See -->
<!-- `20230324 - QA - Dec-22 sentencing and receptions prepartion.xlsx` on DOM1. -->


<!-- ### Plot Charlotte's population data -->

```{r echo=FALSE}

path_target <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-RR_test_230612.xlsx"

court_disposals_target <- suppressMessages(import_s3_file(path_target, range = "population!G5:V54")) %>%
  dplyr::mutate(date = lubridate::floor_date(as.Date(`Row Labels`), "month"), .keep = "unused")

target_pop_det_formatted <- format_charlotte_population_data(court_disposals_target)

```



<!-- ### Calculate baseline of `prisonsreadyreckoner` -->

```{r echo=FALSE}

pop_baseline <- run_baseline(params, inflows_det_loaded, profiles_det_loaded,
                             nomis_out_delius_in_ratio, profiles_lic, recall_rate_exclPSS, profiles_recall)

```


<!-- CHECK with Charlotte: Summing _0 and _1 flags in baseline disposals (i.e. s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4.xlsx), but not in the RR differences files (i.e. s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4_RR_test_max.xlsx and  -->
<!-- s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4_RR_test_min.xlsx). Is this correct? -->

<!-- ### Calculate `prisonsreadyreckoner` outputs using extra court disposals -->

```{r echo=FALSE}


# Load Crown Court disposals data from Charlotte
charlotte_baseline_cc_disposals_file <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-sentencing_outputs_apr23_s4.xlsx"
charlotte_baseline_cc_disposals_loaded <- import_s3_file(charlotte_baseline_cc_disposals_file, sheet = "disp_plea_impactrr_out_apr23_s4")
charlotte_baseline_cc_disposals <- format_charlotte_cc_disposals(charlotte_baseline_cc_disposals_loaded, params$forecast_start_date, params$forecast_end_date, flag = "all")

charlotte_low_cc_disposals_file <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-sentencing_outputs_apr23_s4_RR_test_min.xlsx"
charlotte_low_cc_disposals_loaded <- import_s3_file(charlotte_low_cc_disposals_file, sheet = "disp_plea_impactrr_out_apr23_s4")
charlotte_low_cc_disposals <- format_charlotte_cc_disposals(charlotte_low_cc_disposals_loaded, params$forecast_start_date, params$forecast_end_date, flag = 0)
charlotte_low_cc_disposals_delta <- calculate_charlotte_disposals_delta(charlotte_low_cc_disposals, charlotte_baseline_cc_disposals)

charlotte_high_cc_disposals_file <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-sentencing_outputs_apr23_s4_RR_test_max.xlsx"
charlotte_high_cc_disposals_loaded <- import_s3_file(charlotte_high_cc_disposals_file, sheet = "disp_plea_impactrr_out_apr23_s4")
charlotte_high_cc_disposals <- format_charlotte_cc_disposals(charlotte_high_cc_disposals_loaded, params$forecast_start_date, params$forecast_end_date, flag = 0)
charlotte_high_cc_disposals_delta <- calculate_charlotte_disposals_delta(charlotte_high_cc_disposals, charlotte_baseline_cc_disposals)


# Load magistrates' court disposals data from Charlotte
charlotte_baseline_mc_disposals_file <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-apr23_test_output_mags_med.csv"
charlotte_baseline_mc_disposals_loaded <- suppressMessages(import_s3_file(charlotte_baseline_mc_disposals_file))
charlotte_baseline_mc_disposals <- format_charlotte_mc_disposals(charlotte_baseline_mc_disposals_loaded, params$forecast_start_date, params$forecast_end_date)

charlotte_low_mc_disposals_file <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-apr23_test_output_mags_med_RR_test_min.csv"
charlotte_low_mc_disposals_loaded <- suppressMessages(import_s3_file(charlotte_low_mc_disposals_file))
charlotte_low_mc_disposals <- format_charlotte_mc_disposals(charlotte_low_mc_disposals_loaded, params$forecast_start_date, params$forecast_end_date)
charlotte_low_mc_disposals_delta <- calculate_charlotte_disposals_delta(charlotte_low_mc_disposals, charlotte_baseline_mc_disposals)

charlotte_high_mc_disposals_file <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-apr23_test_output_mags_med_RR_test_max.csv"
charlotte_high_mc_disposals_loaded <- suppressMessages(import_s3_file(charlotte_high_mc_disposals_file))
charlotte_high_mc_disposals <- format_charlotte_mc_disposals(charlotte_high_mc_disposals_loaded, params$forecast_start_date, params$forecast_end_date)
charlotte_high_mc_disposals_delta <- calculate_charlotte_disposals_delta(charlotte_high_mc_disposals, charlotte_baseline_mc_disposals)


### LOW SCENARIO
# Combine Crown Court disposals with magistrates' court disposals.
charlotte_low_disposals_delta <- dplyr::bind_rows(charlotte_low_cc_disposals_delta, charlotte_low_mc_disposals_delta)

# inflows_det_delta_low = 89 rows
inflows_det_delta_low <- calculate_inflows_det_delta_SUB(charlotte_low_disposals_delta, sentencing_rates_loaded)

# Run Charlotte's court disposals through the relevant prisonsreadyreckoner functions
# Add Charlotte's delta inflows to the background inflows
inflows_det_low_adj <- add_inflows_det_delta_courts(inflows_det_loaded, inflows_det_delta_low)

pop_det_low <- run_prisons_module_charlotte_inflows(params, inflows_det_low_adj, profiles_det_loaded) 


### HIGH SCENARIO
# Combine Crown Court disposals with magistrates' court disposals.
charlotte_high_disposals_delta <- dplyr::bind_rows(charlotte_high_cc_disposals_delta, charlotte_high_mc_disposals_delta)

# inflows_det_delta_low = 89 rows
inflows_det_delta_high <- calculate_inflows_det_delta_SUB(charlotte_high_disposals_delta, sentencing_rates_loaded)

# Run Charlotte's court disposals through the relevant prisonsreadyreckoner functions
# Add Charlotte's delta inflows to the background inflows
inflows_det_high_adj <- add_inflows_det_delta_courts(inflows_det_loaded, inflows_det_delta_high)

pop_det_high <- run_prisons_module_charlotte_inflows(params, inflows_det_high_adj, profiles_det_loaded) 


### Combine baseline, low and high scenarios
pop_baseline_long <- pop_baseline %>%
  dplyr::filter(casetype == "determinate") %>%
  tidyr::pivot_longer(-c("run", "casetype", "senband"), names_to = "date", values_to = "population") %>%
  tidyr::pivot_wider(names_from = senband, values_from = population) %>%
  dplyr::rename(prr_baseline_sb1 = senband1,
                prr_baseline_sb2 = senband2,
                prr_baseline_sb3 = senband3,
                prr_baseline_sb4 = senband4) %>%
  dplyr::mutate(date = as.Date(date)) %>%
  dplyr::select(-c("run", "casetype"))


pop_det_low_long <- pop_det_low %>%
  tidyr::pivot_longer(-c("run", "casetype", "senband"), names_to = "date", values_to = "population") %>%
  tidyr::pivot_wider(names_from = senband, values_from = population) %>%
  dplyr::rename(prr_pop_det_low_sb1 = senband1,
                prr_pop_det_low_sb2 = senband2,
                prr_pop_det_low_sb3 = senband3,
                prr_pop_det_low_sb4 = senband4) %>%
  dplyr::mutate(date = as.Date(date)) %>%
  dplyr::select(-c("run", "casetype"))


pop_det_high_long <- pop_det_high %>%
  tidyr::pivot_longer(-c("run", "casetype", "senband"), names_to = "date", values_to = "population") %>%
  tidyr::pivot_wider(names_from = senband, values_from = population) %>%
  dplyr::rename(prr_pop_det_high_sb1 = senband1,
                prr_pop_det_high_sb2 = senband2,
                prr_pop_det_high_sb3 = senband3,
                prr_pop_det_high_sb4 = senband4) %>%
  dplyr::mutate(date = as.Date(date)) %>%
  dplyr::select(-c("run", "casetype"))


### Bind CJST and prisonsreadyreckoner populations together, and calculate relevant measures
pop_table <- target_pop_det_formatted %>%
  dplyr::left_join(pop_baseline_long, by = c("date")) %>%
  dplyr::left_join(pop_det_low_long, by = c("date")) %>%
  dplyr::left_join(pop_det_high_long, by = c("date")) %>%
  dplyr::mutate(cjst_high_pop_delta = cjst_high_pop - cjst_central_pop,
                cjst_low_pop_delta = cjst_low_pop - cjst_central_pop,
                prr_baseline_pop = prr_baseline_sb1 + prr_baseline_sb2 + prr_baseline_sb3 + prr_baseline_sb4,
                prr_pop_det_high = prr_pop_det_high_sb1 + prr_pop_det_high_sb2 + prr_pop_det_high_sb3+ prr_pop_det_high_sb4,
                prr_pop_det_low = prr_pop_det_low_sb1 + prr_pop_det_low_sb2 + prr_pop_det_low_sb3+ prr_pop_det_low_sb4,
                prr_pop_det_high_delta = prr_pop_det_high - prr_baseline_pop,
                prr_pop_det_low_delta = prr_pop_det_low - prr_baseline_pop,
                cjst_prr_pop_high_diff = cjst_high_pop_delta - prr_pop_det_high_delta,
                cjst_prr_pop_low_diff = cjst_low_pop_delta - prr_pop_det_low_delta)

```


### Summary ###

* Determinate sentence prison populations predicted using the Prisons Submodule and Courts Submodule of `prisonsreadyreckoner` are compared to populations predicted by the [CJS Modelling team](https://peoplefinder.service.gov.uk/teams/justice-system-modelling-criminal-justice) using the same input data.
* Comparisons are carried out for a **Low** scenario (i.e. low rates of court receipts and disposals) and a **High** scenario (i.e. high rates of court receipts and disposals).
* The Prisons Submodule performs excellently.
* The Courts Submodule performs well for the **Low** scenario, but not as well for the **High** scenario.
* Worse performance of the Courts Submodule for the **High** scenario may be because regression used for sentencing rates is not trained on data that extend to such high volumes.



<!-- ### Aim ### -->

<!-- The aim of this visualisation is to test the performance of the Courts and Sentencing Submodules of `prisonsreadyreckoner` using data produced by the [CJS Modelling team](https://peoplefinder.service.gov.uk/teams/justice-system-modelling-criminal-justice). Specifically, it uses three scenarios (**Low**, **Central** and **High**) in which the number of cases disposed of by the magistrates' courts and the number of cases received by the Crown Courts are varied. For each scenario, two tests are carried out: -->

<!-- * *Testing Courts Submodule and Prison Submodule*: Magistrates' court disposals and Crown Court receipts are passed through the `prisonsreadyreckoner` Courts Submodule followed by the Prisons Submodule. The resultant determinate sentence prison population is compared to the population predicted by the CJS Modelling team using the same court disposals and receipts. -->
<!-- * *Testing Prisons Submodule only*: Determinate sentence prison receptions (predicted from court disposals and receipts by the CJS Modelling team) are passed through the `prisonsreadyreckoner` Prisons Submodule. The resultant determinate sentence prison population is compared to the population predicted by the CJS Modelling team using the same court disposals and receipts. -->


### Testing Courts Submodule and Prison Submodule

* Magistrates' court disposals and Crown Court receipts are passed through the `prisonsreadyreckoner` Courts Submodule followed by the Prisons Submodule.
* **Low**, **Central** and **High** scenarios are used.
* Each scenario relies on two files of input data:
  + **Low**:
    - **Magistrates' court disposals**: s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-apr23_test_output_mags_med_RR_test_min.csv (copied from original location s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_0901/mags_projections/projections_from_mags_model_built_2022_02/2022_06/apr23_test_output_mags_med_RR_test_min.csv).
    - **Crown Court receipts**: s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-sentencing_outputs_apr23_s4_RR_test_min.xlsx (copied from original location s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4_RR_test_min.xlsx).
  + **Central**:
    - **Magistrates' court disposals**: s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-apr23_test_output_mags_med.csv (copied from original location s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_0901/mags_projections/projections_from_mags_model_built_2022_02/2022_06/apr23_test_output_mags_med.csv).
    - **Crown Court receipts**: s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-sentencing_outputs_apr23_s4.xlsx (copied from original location s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4.xlsx).
  + **High**:
    - **Magistrates' court disposals**: s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-apr23_test_output_mags_med_RR_test_max.csv (copied from original location s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_0901/mags_projections/projections_from_mags_model_built_2022_02/2022_06/apr23_test_output_mags_med_RR_test_max.csv).
    - **Crown Court receipts**: s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-sentencing_outputs_apr23_s4_RR_test_max.xlsx (copied from original location s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4_RR_test_max.xlsx).
    
**Graph 1** shows the determinate sentence prison population for each scenario calculated by `prisonsreadyreckoner`, and also shows the population for each scenario calculated by the CJS Modelling team (these results are loaded from the file s3://alpha-prison-forecasting-data/flowcast/test-files/test-RR_test_230612.xlsx).

  * *Note*: The `prisonreadyreckoner` populations increase from a value of zero in March 2023 as `prisonreadyreckoner` models only offenders who enter prison after this date. The CJS Modelling team populations, in contrast, include prisoners who entered prison before March 2023.
  
**Graph 2** shows the divergences of the **High** and **Low** populations from the Central populations (i.e. the dashed black line in **Graph 1** for `prisonsreadyreckoner` and the solid black line in **Graph 1** for the CJS Modelling team).

  * The **Low** divergence of `prisonsreadyreckoner` matches the **Low** divergence of the CJS Modelling team.
  * The **High** divergences do not match well.



<!-- For each scenario, `prisonsreadyreckoner` takes magistrates' court disposals and Crown Court receipts from the two files and calculates the resulting determinate sentence prison population.  -->


```{r echo = FALSE}


ggplot2::ggplot() +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = cjst_central_pop, color = "Central (CJS Modelling team)", linetype = "Central (CJS Modelling team)")) +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = cjst_high_pop, color = "High (CJS Modelling team)", linetype = "High (CJS Modelling team)")) + 
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = cjst_low_pop, color = "Low (CJS Modelling team)", linetype = "Low (CJS Modelling team)")) +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = prr_baseline_pop, color = "Central (prisonsreadyreckoner)", linetype = "Central (prisonsreadyreckoner)")) +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = prr_pop_det_high, color = "High (prisonsreadyreckoner)", linetype = "High (prisonsreadyreckoner)")) +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = prr_pop_det_low, color = "Low (prisonsreadyreckoner)", linetype = "Low (prisonsreadyreckoner)")) +
  ggplot2::scale_linetype_manual(name = " ", values = c("Central (CJS Modelling team)" = "solid", "High (CJS Modelling team)" = "solid", "Low (CJS Modelling team)" = "solid", "Central (prisonsreadyreckoner)" = "dashed", "High (prisonsreadyreckoner)" = "dashed", "Low (prisonsreadyreckoner)" = "dashed")) + 
  ggplot2::scale_color_manual(name = " ", values = c("Central (CJS Modelling team)" = "black", "High (CJS Modelling team)" = "blue", "Low (CJS Modelling team)" = "red", "Central (prisonsreadyreckoner)" = "black", "High (prisonsreadyreckoner)" = "blue", "Low (prisonsreadyreckoner)" = "red")) +
  ggplot2::labs(title = "Graph 1: Determinate sentence prison population", x = "", y = "Population", caption = "") +
  ggplot2::theme_classic()

```




```{r echo = FALSE}

ggplot2::ggplot(data = pop_table) +
  ggplot2::geom_line(ggplot2::aes(x = date, y = cjst_high_pop_delta, color = "High (CJS Modelling team)", linetype = "High (CJS Modelling team)")) + 
  ggplot2::geom_line(ggplot2::aes(x = date, y = cjst_low_pop_delta, color = "Low (CJS Modelling team)", linetype = "Low (CJS Modelling team)")) +
  ggplot2::geom_line(ggplot2::aes(x = date, y = prr_pop_det_high_delta, color = "High (prisonsreadyreckoner)", linetype = "High (prisonsreadyreckoner)")) +
  ggplot2::geom_line(ggplot2::aes(x = date, y = prr_pop_det_low_delta, color = "Low (prisonsreadyreckoner)", linetype = "Low (prisonsreadyreckoner)")) +
  ggplot2::scale_linetype_manual(name = " ", values = c("High (CJS Modelling team)" = "solid", "Low (CJS Modelling team)" = "solid", "High (prisonsreadyreckoner)" = "dashed", "Low (prisonsreadyreckoner)" = "dashed")) + 
  ggplot2::scale_color_manual(name = " ", values = c("High (CJS Modelling team)" = "blue", "Low (CJS Modelling team)" = "red", "High (prisonsreadyreckoner)" = "blue", "Low (prisonsreadyreckoner)" = "red")) +
  ggplot2::labs(title = "Graph 2: Divergence of determinate sentence prison population from Central scenario", x = "", y = "Divergence", caption = "") +
  ggplot2::theme_classic()

```






## Testing Prisons Submodule only


* **Low**, **Central** and **High** scenarios takes determinate sentence prison receptions from file s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-RR_test_230612.xlsx.

**Graph 3** shows the determinate sentence prison population for each scenario calculated by `prisonsreadyreckoner`, and also shows the population for each scenario calculated by the CJS Modelling team (these results are loaded from the file s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-RR_test_230612.xlsx).
  
  * *Note*: The `prisonreadyreckoner` populations increase from a value of zero in March 2023 as `prisonreadyreckoner` models only offenders who enter prison after this date. The CJS Modelling team populations, in contrast, include prisoners who entered prison before March 2023.
  
**Graph 4** shows the divergence of the **High** and **Low** populations from the Central population.

  * Excellent match between the `prisonsreadyreckoner` and the CJS Modelling team populations.



```{r echo=FALSE}

path_target <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-RR_test_230612.xlsx"

prison_inflows_low_high <- suppressMessages(import_s3_file(path_target, range = "receptions!A5:M90")) %>%
  dplyr::mutate(date = lubridate::floor_date(as.Date(`Row Labels`), "month"), .keep = "unused") %>%
  dplyr::filter(date >= params$forecast_start_date, date <= params$forecast_end_date)


prison_inflows_central <- prison_inflows_low_high %>%
  dplyr::select(c("date", "sensitivity_baseline_uncalib...4", "sensitivity_baseline_uncalib...7", "sensitivity_baseline_uncalib...10", "sensitivity_baseline_uncalib...13")) %>%
  dplyr::rename(senband1 = sensitivity_baseline_uncalib...4,
                senband2 = sensitivity_baseline_uncalib...7,
                senband3 = sensitivity_baseline_uncalib...10,
                senband4 = sensitivity_baseline_uncalib...13
  ) %>%
  tidyr::pivot_longer(cols=-1) %>%
  tidyr::pivot_wider(names_from = date, values_from = value) %>%
  dplyr::rename(senband = name)


prison_inflows_low <- prison_inflows_low_high %>%
  dplyr::select(c("date", "RR_test_low_disposals...3", "RR_test_low_disposals...6", "RR_test_low_disposals...9", "RR_test_low_disposals...12")) %>%
  dplyr::rename(senband1 = RR_test_low_disposals...3,
                senband2 = RR_test_low_disposals...6,
                senband3 = RR_test_low_disposals...9,
                senband4 = RR_test_low_disposals...12
                ) %>%
  tidyr::pivot_longer(cols=-1) %>%
  tidyr::pivot_wider(names_from = date, values_from = value) %>%
  dplyr::rename(senband = name)


prison_inflows_high <- prison_inflows_low_high %>%
  dplyr::select(c("date", "RR_test_high_disposals...2", "RR_test_high_disposals...5", "RR_test_high_disposals...8", "RR_test_high_disposals...11")) %>%
  dplyr::rename(senband1 = RR_test_high_disposals...2,
                senband2 = RR_test_high_disposals...5,
                senband3 = RR_test_high_disposals...8,
                senband4 = RR_test_high_disposals...11
  ) %>%
  tidyr::pivot_longer(cols=-1) %>%
  tidyr::pivot_wider(names_from = date, values_from = value) %>%
  dplyr::rename(senband = name)



prison_det_outputs_central <- run_prison_determinate_module(prison_inflows_central, params$lever_profiles_det_stretch_impact_date, profiles_det_loaded)
outflows_det_central     <- prison_det_outputs_central$outflows_det
pop_det_central          <- prison_det_outputs_central$pop_det

prison_det_outputs_low <- run_prison_determinate_module(prison_inflows_low, params$lever_profiles_det_stretch_impact_date, profiles_det_loaded)
outflows_det_low     <- prison_det_outputs_low$outflows_det
pop_det_low          <- prison_det_outputs_low$pop_det

prison_det_outputs_high <- run_prison_determinate_module(prison_inflows_high, params$lever_profiles_det_stretch_impact_date, profiles_det_loaded)
outflows_det_high     <- prison_det_outputs_high$outflows_det
pop_det_high          <- prison_det_outputs_high$pop_det


### Combine central, low and high scenarios
pop_central_long <- pop_det_central %>%
  tidyr::pivot_longer(-c("senband"), names_to = "date", values_to = "population") %>%
  tidyr::pivot_wider(names_from = senband, values_from = population) %>%
  dplyr::rename(prr_central_sb1 = senband1,
                prr_central_sb2 = senband2,
                prr_central_sb3 = senband3,
                prr_central_sb4 = senband4) %>%
  dplyr::mutate(date = as.Date(date))


pop_det_low_long <- pop_det_low %>%
  tidyr::pivot_longer(-c("senband"), names_to = "date", values_to = "population") %>%
  tidyr::pivot_wider(names_from = senband, values_from = population) %>%
  dplyr::rename(prr_pop_det_low_sb1 = senband1,
                prr_pop_det_low_sb2 = senband2,
                prr_pop_det_low_sb3 = senband3,
                prr_pop_det_low_sb4 = senband4) %>%
  dplyr::mutate(date = as.Date(date))


pop_det_high_long <- pop_det_high %>%
  tidyr::pivot_longer(-c("senband"), names_to = "date", values_to = "population") %>%
  tidyr::pivot_wider(names_from = senband, values_from = population) %>%
  dplyr::rename(prr_pop_det_high_sb1 = senband1,
                prr_pop_det_high_sb2 = senband2,
                prr_pop_det_high_sb3 = senband3,
                prr_pop_det_high_sb4 = senband4) %>%
  dplyr::mutate(date = as.Date(date))



### Bind CJST and prisonsreadyreckoner populations together, and calculate relevant measures
pop_table <- target_pop_det_formatted %>%
  dplyr::left_join(pop_central_long, by = c("date")) %>%
  dplyr::left_join(pop_det_low_long, by = c("date")) %>%
  dplyr::left_join(pop_det_high_long, by = c("date")) %>%
  dplyr::mutate(cjst_high_pop_delta = cjst_high_pop - cjst_central_pop,
                cjst_low_pop_delta = cjst_low_pop - cjst_central_pop,
                prr_central_pop = prr_central_sb1 + prr_central_sb2 + prr_central_sb3 + prr_central_sb4,
                prr_pop_det_high = prr_pop_det_high_sb1 + prr_pop_det_high_sb2 + prr_pop_det_high_sb3+ prr_pop_det_high_sb4,
                prr_pop_det_low = prr_pop_det_low_sb1 + prr_pop_det_low_sb2 + prr_pop_det_low_sb3+ prr_pop_det_low_sb4,
                prr_pop_det_high_delta = prr_pop_det_high - prr_central_pop,
                prr_pop_det_low_delta = prr_pop_det_low - prr_central_pop,
                cjst_prr_pop_high_diff = cjst_high_pop_delta - prr_pop_det_high_delta,
                cjst_prr_pop_low_diff = cjst_low_pop_delta - prr_pop_det_low_delta)

```


```{r echo = FALSE}


ggplot2::ggplot() +
  ggplot2::geom_line(data = pop_table, ggplot2::aes( x = date, y = cjst_central_pop, color = "Central (CJS Modelling team)", linetype = "Central (CJS Modelling team)")) +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = cjst_high_pop, color = "High (CJS Modelling team)", linetype = "High (CJS Modelling team)")) + 
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = cjst_low_pop, color = "Low (CJS Modelling team)", linetype = "Low (CJS Modelling team)")) +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = prr_central_pop, color = "prr_central_pop", linetype = "prr_central_pop")) +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = prr_pop_det_high, color = "High (prisonsreadyreckoner)", linetype = "High (prisonsreadyreckoner)")) +
  ggplot2::geom_line(data = pop_table, ggplot2::aes(x = date, y = prr_pop_det_low, color = "Low (prisonsreadyreckoner)", linetype = "Low (prisonsreadyreckoner)")) +
  ggplot2::scale_linetype_manual(name = " ", values = c("Central (CJS Modelling team)" = "solid", "High (CJS Modelling team)" = "solid", "Low (CJS Modelling team)" = "solid", "prr_central_pop" = "dashed", "High (prisonsreadyreckoner)" = "dashed", "Low (prisonsreadyreckoner)" = "dashed")) + 
  ggplot2::scale_color_manual(name = " ", values = c("Central (CJS Modelling team)" = "black", "High (CJS Modelling team)" = "blue", "Low (CJS Modelling team)" = "red", "prr_central_pop" = "black", "High (prisonsreadyreckoner)" = "blue", "Low (prisonsreadyreckoner)" = "red")) +
  ggplot2::labs(title = "Determinate sentence prison population", x = "", y = "Population", caption = "") +
  ggplot2::theme_classic()


ggplot2::ggplot(data = pop_table) +
  ggplot2::geom_line(ggplot2::aes(x = date, y = cjst_high_pop_delta, color = "High (CJS Modelling team)", linetype = "High (CJS Modelling team)")) + 
  ggplot2::geom_line(ggplot2::aes(x = date, y = cjst_low_pop_delta, color = "Low (CJS Modelling team)", linetype = "Low (CJS Modelling team)")) +
  ggplot2::geom_line(ggplot2::aes(x = date, y = prr_pop_det_high_delta, color = "High (prisonsreadyreckoner)", linetype = "High (prisonsreadyreckoner)")) +
  ggplot2::geom_line(ggplot2::aes(x = date, y = prr_pop_det_low_delta, color = "Low (prisonsreadyreckoner)", linetype = "Low (prisonsreadyreckoner)")) +
  ggplot2::scale_linetype_manual(name = " ", values = c("High (CJS Modelling team)" = "solid", "Low (CJS Modelling team)" = "solid", "High (prisonsreadyreckoner)" = "dashed", "Low (prisonsreadyreckoner)" = "dashed")) + 
  ggplot2::scale_color_manual(name = " ", values = c("High (CJS Modelling team)" = "blue", "Low (CJS Modelling team)" = "red", "High (prisonsreadyreckoner)" = "blue", "Low (prisonsreadyreckoner)" = "red")) +
  ggplot2::labs(title = "Divergence of determinate sentence prison population from Central scenario", x = "", y = "Divergence", caption = "") +
  ggplot2::theme_classic()


```


### Conclusions

* Excellent performance of `prisonsreadyreckoner` Prisons Submodule suggests that divergence of `prisonsreadyreckoner` from CJS Modelling team for **High** scenario in **Graph 2** is caused by Courts Submodule.
* Worse performance of Courts Submodule for **High** scenario may be because regression used for Crown Court disposals is not trained on data that extend to these high volumes.


### Note 

The inflow values in s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-RR_test_230612.xlsx are slightly different to the inflows used in `prisonsreadyreckoner` (see s3://alpha-app-prisonsreadyreckonerapp/2023-04/detailed_apr23_s4_apr23_flat_3m_linear_6m_msim_EDS_change_os_adj_DandS_3m_current_6m_avg_longterm_230426_150555.xlsx). The differences are minimal, so are unlikely to affect the results presented here.




```{r echo=FALSE}

### Comparing different inflows

inflows_det_loaded_pivoted <- inflows_det_loaded %>%
  tidyr::pivot_longer(-c("senband"), names_to = "date", values_to = "population") %>%
  tidyr::pivot_wider(names_from = senband, values_from = population) %>%
  dplyr::rename(prr_orig_inflows_sb1 = senband1,
                prr_orig_inflows_sb2 = senband2,
                prr_orig_inflows_sb3 = senband3,
                prr_orig_inflows_sb4 = senband4) %>%
  dplyr::mutate(date = as.Date(date))


prison_inflows_comparison <- inflows_det_loaded_pivoted %>%
  dplyr::left_join(prison_inflows_low_high, by = c("date")) %>%
  dplyr::rename(central_inflows_sb1 = sensitivity_baseline_uncalib...4,
                central_inflows_sb2 = sensitivity_baseline_uncalib...7,
                central_inflows_sb3 = sensitivity_baseline_uncalib...10,
                central_inflows_sb4 = sensitivity_baseline_uncalib...13,
                high_inflows_sb1 = RR_test_high_disposals...2,
                high_inflows_sb2 = RR_test_high_disposals...5,
                high_inflows_sb3 = RR_test_high_disposals...8,
                high_inflows_sb4 = RR_test_high_disposals...11,
                low_inflows_sb1 = RR_test_low_disposals...3,
                low_inflows_sb2 = RR_test_low_disposals...6,
                low_inflows_sb3 = RR_test_low_disposals...9,
                low_inflows_sb4 = RR_test_low_disposals...12)


ggplot2::ggplot() +
  ggplot2::geom_line(data = prison_inflows_comparison, ggplot2::aes(x = date, y = prr_orig_inflows_sb1, color = "prisonsreadyreckoner (Sentence Band 1)", linetype = "prisonsreadyreckoner (Sentence Band 1)")) +
  ggplot2::geom_line(data = prison_inflows_comparison, ggplot2::aes(x = date, y = prr_orig_inflows_sb2, color = "prisonsreadyreckoner (Sentence Band 2)", linetype = "prisonsreadyreckoner (Sentence Band 2)")) + 
  ggplot2::geom_line(data = prison_inflows_comparison, ggplot2::aes(x = date, y = prr_orig_inflows_sb3, color = "prisonsreadyreckoner (Sentence Band 3)", linetype = "prisonsreadyreckoner (Sentence Band 3)")) +
  ggplot2::geom_line(data = prison_inflows_comparison, ggplot2::aes(x = date, y = prr_orig_inflows_sb4, color = "prisonsreadyreckoner (Sentence Band 4)", linetype = "prisonsreadyreckoner (Sentence Band 4)")) +
  ggplot2::geom_line(data = prison_inflows_comparison, ggplot2::aes(x = date, y = central_inflows_sb1, color = "CJS (Sentence Band 1)", linetype = "CJS (Sentence Band 1)")) +
  ggplot2::geom_line(data = prison_inflows_comparison, ggplot2::aes(x = date, y = central_inflows_sb2, color = "CJS (Sentence Band 2)", linetype = "CJS (Sentence Band 2)")) +
  ggplot2::geom_line(data = prison_inflows_comparison, ggplot2::aes(x = date, y = central_inflows_sb3, color = "CJS (Sentence Band 3)", linetype = "CJS (Sentence Band 3)")) +
  ggplot2::geom_line(data = prison_inflows_comparison, ggplot2::aes(x = date, y = central_inflows_sb4, color = "CJS (Sentence Band 4)", linetype = "CJS (Sentence Band 4)")) +
  ggplot2::scale_linetype_manual(name = " ", values = c("CJS (Sentence Band 1)" = "solid",
                                                        "CJS (Sentence Band 2)" = "solid",
                                                        "CJS (Sentence Band 3)" = "solid",
                                                        "CJS (Sentence Band 4)" = "solid",
                                                        "prisonsreadyreckoner (Sentence Band 1)" = "dashed",
                                                        "prisonsreadyreckoner (Sentence Band 2)" = "dashed",
                                                        "prisonsreadyreckoner (Sentence Band 3)" = "dashed",
                                                        "prisonsreadyreckoner (Sentence Band 4)" = "dashed"
                                                        )) +
  ggplot2::scale_color_manual(name = " ", values = c("CJS (Sentence Band 1)" = "black",
                                                     "CJS (Sentence Band 2)" = "red",
                                                     "CJS (Sentence Band 3)" = "green",
                                                     "CJS (Sentence Band 4)" = "blue",
                                                     "prisonsreadyreckoner (Sentence Band 1)" = "black",
                                                     "prisonsreadyreckoner (Sentence Band 2)" = "red",
                                                     "prisonsreadyreckoner (Sentence Band 3)" = "green",
                                                     "prisonsreadyreckoner (Sentence Band 4)" = "blue"
  )) +
  ggplot2::labs(title = "Determinate sentence prison receptions", x = "", y = "Receptions", caption = "") +
  ggplot2::theme_classic()


```
