---
title: "Statistics of court proceedings projections from Criminal Justice Scenario Tool"
author: "Alex Dickinson"
date: "11/04/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
```

```{r include=FALSE}
library(magrittr)


# Round values to number of significant figures determined by standard deviation. 
round_to_sf <- function(x, sd_x) {

  if (x == 0 || sd_x == 0 || is.nan(x) || is.nan(sd_x)) {
    x_round <- x
    sd_x_round <- sd_x
  } else {
    
    sd_x_power <- -as.integer(floor(log10(abs(sd_x))))
    sd_x_first_digit <- round(sd_x, digits=sd_x_power) * 10 ^ as.numeric(sd_x_power)
    
    if (sd_x_first_digit < 3) {
      n <- 2
    } else {
      n <- 1
    }
    
    sd_x_round <- round(sd_x, digits=(sd_x_power + (n - 1))) 
    x_round <- round(x, digits=(sd_x_power + (n - 1)))
    
    if (sd_x_round %% 1 == 0) {
      x_round <- as.integer(x_round)
      sd_x_round <- as.integer(sd_x_round)
    }
  }

  return(list(x_round=x_round, sd_x_round=sd_x_round))
}

# plot_series <- function(series, main, ylab) {
#   
#   x <- as.Date(names(dplyr::select(series, -c("SenBand"))))
#   y <- dplyr::select(series, -c("SenBand"))
#   matplot(x,
#          t(y),
#          'l',
#          lty = c(rep(1, 4), rep(2, 4)),
#          col = seq(1, 4),
#          xlab = "Date", main = main, ylab = ylab)
#   legend("topleft",
#      inset = 0.02,
#      legend = paste0("SB ", series$SenBand),
#      lty = c(rep(1, 4), rep(2, 4)),
#      col = seq(1, 4)
#   )
# }
```


Projections of the number and duration of receipts and disposals and of the size
of the case backlog are generated by the Criminal Justice Scenario Tool (CJST)
and are saved as s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_io_res_12m_taper_230406_1019/crown-output-apr23_s4.csv. In case this file is deleted or moved in future, it has been copied to s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-crown-output-apr23_s4.csv for use in this document.


```{r echo=FALSE, results = 'asis'}
crown_output_csv <- import_s3_file("s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-crown-output-apr23_s4.csv")

knitr::kable(head(crown_output_csv),
             caption = "First six rows of s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-crown-output-apr23_s4.csv.")
```




# Number of court minutes taken per case


## Receipts

The number of court minutes taken by each receipt is calculated by dividing `dur_receipts` by `n_receipts`. These values are sorted by month.


```{r echo=FALSE, out.width="100%"}

# print("crown_output_csv")
# print(crown_output_csv)

crown_output_csv_pivoted <- tidyr::unite(crown_output_csv, receipt_type_route, c(receipt_type_desc, actual_route), sep = " ") %>%
  dplyr::mutate(days_per_receipt  = dur_receipts / n_receipts) %>%
  dplyr::select(c("date", "receipt_type_route", "days_per_receipt")) %>%
  tidyr::pivot_wider(
    names_from = date,
    values_from = days_per_receipt,
    values_fill = 0,
    names_sort = TRUE
  )

# print("crown_output_csv_pivoted")
# print(crown_output_csv_pivoted)

x <- as.Date(names(dplyr::select(crown_output_csv_pivoted, -c("receipt_type_route"))))
y <- dplyr::select(crown_output_csv_pivoted, -c("receipt_type_route"))

matplot(x,
        t(y),
        type = 'l',
        xlab = "Date",
        main = "Minutes per receipt",
        ylab = "Minutes",
        lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
        col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7)
        )

legend("topright",
       inset = 0.02,
       legend = paste0(crown_output_csv_pivoted$receipt_type_route),
       lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
       col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
       cex = 0.5
)
```

The plot below shows a zoom of the lower portion of the plot above.

```{r echo=FALSE, out.width="100%"}

matplot(x,
        t(y),
        type = 'l',
        xlab = "Date",
        main = "Minutes per receipt",
        ylab = "Minutes",
        lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
        col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
        ylim = c(0,200)
        )

legend("topright",
       inset = 0.02,
       legend = paste0(crown_output_csv_pivoted$receipt_type_route),
       lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
       col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
       cex = 0.5
)
```

There is little deviation from the mean values of minutes per receipt. (Note that each month contributes an equal weight to these means. The means are *not* weighted by the number of cases each month.) 

```{r echo=FALSE, results = 'asis'}

crown_output_csv_averages <- dplyr::mutate(crown_output_csv, days_per_receipt  = dur_receipts / n_receipts) %>%
  dplyr::group_by(receipt_type_desc, actual_route) %>%
  dplyr::summarise(mean=mean(days_per_receipt), sd=sd(days_per_receipt), .groups = "keep") %>%
  dplyr::mutate(mean_new = round_to_sf(mean, sd)$mean) %>%
  dplyr::mutate(cv = sd / mean) %>%
  dplyr::arrange(desc(mean))

knitr::kable(crown_output_csv_averages,
             caption = "Table showing mean values of number of court minutes taken by each receipt, grouped by `receipt_type_desc` and `actual_route`. Rows are sorted according to size of the mean value. mean = mean (in minutes); sd = standard deviation (in minutes); cv = coefficient of variation (dimensionless).")
```



## Disposals

The number of minutes taken by each disposal is calculated by dividing `dur_disposals` by `n_disposals`. These values are sorted by month.


```{r echo=FALSE, out.width="100%"}

crown_output_csv_pivoted <- tidyr::unite(crown_output_csv, receipt_type_route, c(receipt_type_desc, actual_route), sep = " ") %>%
  dplyr::mutate(days_per_disposal  = dur_disposals / n_disposals) %>%
  dplyr::select(c("date", "receipt_type_route", "days_per_disposal")) %>%
  tidyr::pivot_wider(
    names_from = date,
    values_from = days_per_disposal,
    values_fill = 0,
    names_sort = TRUE
  )

x <- as.Date(names(dplyr::select(crown_output_csv_pivoted, -c("receipt_type_route"))))
y <- dplyr::select(crown_output_csv_pivoted, -c("receipt_type_route"))

matplot(x,
        t(y),
        type = 'l',
        xlab = "Date",
        main = "Minutes per disposal",
        ylab = "Minutes",
        lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
        col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7)
        )

legend("topright",
       inset = 0.02,
       legend = paste0(crown_output_csv_pivoted$receipt_type_route),
       lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
       col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
       cex = 0.5
)
```

The plot below shows a zoom of the lower portion of the plot above.

```{r echo=FALSE, out.width="100%"}

matplot(x,
        t(y),
        type = 'l',
        xlab = "Date",
        main = "Minutes per disposal",
        ylab = "Minutes",
        lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
        col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
        ylim = c(0,200)
        )

legend("topright",
       inset = 0.02,
       legend = paste0(crown_output_csv_pivoted$receipt_type_route),
       lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
       col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
       cex = 0.5
)
```

There is little deviation from the mean values of minutes per disposal. (Note that each month contributes an equal weight to these means. The means are *not* weighted by the number of cases each month.) 

```{r echo=FALSE, results = 'asis'}

crown_output_csv_averages <- dplyr::mutate(crown_output_csv, days_per_disposal  = dur_disposals / n_disposals) %>%
  dplyr::group_by(receipt_type_desc, actual_route) %>%
  dplyr::summarise(mean=mean(days_per_disposal), sd=sd(days_per_disposal), .groups = "keep") %>%
  dplyr::mutate(cv = sd / mean) %>%
  dplyr::arrange(desc(mean))

knitr::kable(crown_output_csv_averages,
             caption = "Table showing mean values of number of court minutes taken by each disposal, grouped by `receipt_type_desc` and `actual_route`. Rows are sorted according to size of the mean value. mean = mean (in minutes); sd = standard deviation (in minutes); cv = coefficient of variation (dimensionless).")
```


## Backlog cases

The number of minutes taken by each case in the backlog is calculated by dividing `dur_backlog` by `n_backlog`. These values are sorted by month.


```{r echo=FALSE, out.width="100%"}

crown_output_csv_pivoted <- tidyr::unite(crown_output_csv, receipt_type_route, c(receipt_type_desc, actual_route), sep = " ") %>%
  dplyr::mutate(days_per_backlog_case  = dur_backlog / n_backlog) %>%
  dplyr::select(c("date", "receipt_type_route", "days_per_backlog_case")) %>%
  tidyr::pivot_wider(
    names_from = date,
    values_from = days_per_backlog_case,
    values_fill = 0,
    names_sort = TRUE
  )

x <- as.Date(names(dplyr::select(crown_output_csv_pivoted, -c("receipt_type_route"))))
y <- dplyr::select(crown_output_csv_pivoted, -c("receipt_type_route"))

matplot(x,
        t(y),
        type = 'l',
        xlab = "Date",
        main = "Minutes per backlog case",
        ylab = "Minutes",
        lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
        col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7)
        )

legend("topright",
       inset = 0.02,
       legend = paste0(crown_output_csv_pivoted$receipt_type_route),
       lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
       col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
       cex = 0.5
)
```

The plot below shows a zoom of the lower portion of the plot above.

```{r echo=FALSE, out.width="100%"}

matplot(x,
        t(y),
        type = 'l',
        xlab = "Date",
        main = "Minutes per backlog case",
        ylab = "Minutes",
        lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
        col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
        ylim = c(0,200)
        )

legend("topright",
       inset = 0.02,
       legend = paste0(crown_output_csv_pivoted$receipt_type_route),
       lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
       col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
       cex = 0.5
)
```

There is little deviation from the mean values of minutes per backlog case. (Note that each month contributes an equal weight to these means. The means are *not* weighted by the number of cases each month.) 

```{r echo=FALSE, results = 'asis'}

crown_output_csv_averages <- dplyr::mutate(crown_output_csv, days_per_backlog_case  = dur_backlog / n_backlog) %>%
  dplyr::group_by(receipt_type_desc, actual_route) %>%
  dplyr::summarise(mean=mean(days_per_backlog_case), sd=sd(days_per_backlog_case), .groups = "keep") %>%
  dplyr::mutate(cv = sd / mean) %>%
  dplyr::arrange(desc(mean))

knitr::kable(crown_output_csv_averages,
             caption = "Table showing mean values of number of court minutes taken by each backlog case, grouped by `receipt_type_desc` and `actual_route`. Rows are sorted according to size of the mean value. mean = mean (in minutes); sd = standard deviation (in minutes); cv = coefficient of variation (dimensionless).")
```





# Mix of cases in the backlog

```{r echo=FALSE, out.width="100%"}

crown_output_csv_case_mix_disposals <- tidyr::unite(crown_output_csv, receipt_type_route, c(receipt_type_desc, actual_route), sep = " ") %>%
  dplyr::select(c("date", "receipt_type_route", "n_disposals")) %>%
  tidyr::pivot_wider(
    names_from = date,
    values_from = n_disposals,
    values_fill = 0,
    names_sort = TRUE
  )

x <- as.Date(names(dplyr::select(crown_output_csv_case_mix_disposals, -c("receipt_type_route"))))
y <- dplyr::select(crown_output_csv_case_mix_disposals, -c("receipt_type_route"))

matplot(x,
        t(y),
        type = 'l',
        xlab = "Date",
        main = "Monthly number of backlog cases",
        ylab = "Number",
        lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
        col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7)
        )

legend("topright",
       inset = 0.02,
       legend = paste0(crown_output_csv_case_mix_disposals$receipt_type_route),
       lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
       col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
       cex = 0.5
)
```

The plot below shows a zoom of the lower portion of the plot above.

```{r echo=FALSE, out.width="100%"}

crown_output_csv_case_mix_disposals <- tidyr::unite(crown_output_csv, receipt_type_route, c(receipt_type_desc, actual_route), sep = " ") %>%
  dplyr::select(c("date", "receipt_type_route", "n_disposals")) %>%
  tidyr::pivot_wider(
    names_from = date,
    values_from = n_disposals,
    values_fill = 0,
    names_sort = TRUE
  )

x <- as.Date(names(dplyr::select(crown_output_csv_case_mix_disposals, -c("receipt_type_route"))))
y <- dplyr::select(crown_output_csv_case_mix_disposals, -c("receipt_type_route"))

matplot(x,
        t(y),
        type = 'l',
        xlab = "Date",
        main = "Monthly number of backlog cases",
        ylab = "Number",
        lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
        col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
        ylim = c(0,1500)
        )

legend("topright",
       inset = 0.02,
       legend = paste0(crown_output_csv_case_mix_disposals$receipt_type_route),
       lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
       col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
       cex = 0.5
)
```

Mean numbers of backlog cases can vary significantly for some categories. (Note that each month contributes an equal weight to these means. The means are *not* weighted by the number of cases each month.)

```{r echo=FALSE, results = 'asis'}

average_number_disposals <- crown_output_csv %>%
  dplyr::group_by(receipt_type_desc, actual_route) %>%
  dplyr::summarise(mean=mean(n_disposals), sd=sd(n_disposals), .groups = "keep") %>%
  dplyr::mutate(cv = sd/mean) %>%
  dplyr::arrange(desc(mean))

knitr::kable(average_number_disposals,
             caption = "Table showing mean values of number of backlog cases, grouped by receipt_type_desc and actual_route. Rows are sorted according to size of the mean value. mean = mean; sd = standard deviation; cv = coefficient of variation.")
```

