---
title: "Testing effect of court receptions"
author: "Alex Dickinson"
date: "09/06/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
```

```{r echo=FALSE}

plot_disposals <- function(series, title, ylim, ylab, diff = FALSE) {
  
  if (diff == FALSE) {
    ggplot2::ggplot(data = series) +
    ggplot2::geom_line(ggplot2::aes(x = date, y = RR_test_high_disposals)) + 
    ggplot2::geom_line(ggplot2::aes(x = date, y = RR_test_low_disposals)) +
    ggplot2::geom_line(ggplot2::aes(x = date, y = sensitivity_baseline_uncalib))
  } else if (diff == TRUE) {
    ggplot2::ggplot(data = series) +
    ggplot2::geom_line(ggplot2::aes(x = date, y = RR_test_high_diff)) + 
    ggplot2::geom_line(ggplot2::aes(x = date, y = RR_test_low_diff))
  }
  
  #+
  #ggplot2::ylim(ylim) +
  #ggplot2::labs(x = "Date",
   # y = ylab,
  #  title = title,
  #  subtitle = "")
  
}

```

## Load data from Charlotte

### Court disposals


```{r echo=FALSE}
# See email 20230612 - RE_ Charlotte's RR sense checks.eml

# We load the data in disp_plea_impactrr_out_apr23_s4 sheet. Not sure how familiar you are with these outputs from the crown model? Not all of those columns will be relevant to you (since we consider a few other disposal types/plea routes which you ignore), and you would want to sum the _0 and _1 cols (which indicate baseline demand and the additional impact of 23k extra police officers).
charlotte_baseline_cc_disposals_file <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_apr23_v1/model_outputs/sensitivity_baseline_230412_0819/sentencing_outputs_apr23_s4.xlsx"

# Mags disposals are in this spreadsheet (we just use the column without 23k):
charlotte_baseline_mc_disposals_file <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_0901/mags_projections/projections_from_mags_model_built_2022_02/2022_06/apr23_test_output_mags_med.csv"



charlotte_baseline_cc_disposals <- import_s3_file(charlotte_baseline_cc_disposals_file, sheet = "disp_plea_impactrr_out_apr23_s4")

charlotte_baseline_mc_disposals_file <- import_s3_file(charlotte_baseline_mc_disposals_file)


print(charlotte_baseline_cc_disposals)
print(charlotte_baseline_mc_disposals_file)

```





### Court disposals

Use Charlotte's figures (see email for comparison)

```{r echo=FALSE}

path_target <- "s3://alpha-prison-forecasting-data/flowcast/test-files/test-RR_test_230612.xlsx"

court_disposals_target <- botor::s3_read(path_target,
                           readxl::read_excel,
                           range = "population!G5:V54") %>%
  dplyr::mutate(date = lubridate::floor_date(as.Date(`Row Labels`), "month"), .keep = "unused")

# print("colnames")
# print(colnames(court_disposals_target))
# print(court_disposals_target)

prison_receptions_determinate_target <- court_disposals_target %>%
  dplyr::select(c("RR_test_high_disposals...2", "RR_test_low_disposals...3", "sensitivity_baseline_uncalib...4", "date")) %>%
  dplyr::rename(RR_test_high_disposals = RR_test_high_disposals...2,
                RR_test_low_disposals = RR_test_low_disposals...3,
                sensitivity_baseline_uncalib = sensitivity_baseline_uncalib...4) %>%
  dplyr::mutate(RR_test_high_diff = RR_test_high_disposals - sensitivity_baseline_uncalib,
                RR_test_low_diff = RR_test_low_disposals - sensitivity_baseline_uncalib)

plot_disposals(prison_receptions_determinate_target, "prison_receptions_determinate_target", c(0,100), "Population")
plot_disposals(prison_receptions_determinate_target, "prison_receptions_determinate_target", c(0,100), "Population", diff = TRUE)


prison_receptions_indeterminate_target <- court_disposals_target %>%
  dplyr::select(c("RR_test_high_disposals...5", "RR_test_low_disposals...6", "sensitivity_baseline_uncalib...7", "date")) %>%
  dplyr::rename(RR_test_high_disposals = RR_test_high_disposals...5,
                RR_test_low_disposals = RR_test_low_disposals...6,
                sensitivity_baseline_uncalib = sensitivity_baseline_uncalib...7)

#print(prison_receptions_indeterminate_target)


prison_receptions_recall_target <- court_disposals_target %>%
  dplyr::select(c("RR_test_high_disposals...11", "RR_test_low_disposals...12", "sensitivity_baseline_uncalib...13", "date")) %>%
  dplyr::rename(RR_test_high_disposals = RR_test_high_disposals...11,
                RR_test_low_disposals = RR_test_low_disposals...12,
                sensitivity_baseline_uncalib = sensitivity_baseline_uncalib...13)

#print(prison_receptions_recall_target)


prison_receptions_remand_target <- court_disposals_target %>%
  dplyr::select(c("RR_test_high_disposals...14", "RR_test_low_disposals...15", "sensitivity_baseline_uncalib...16", "date")) %>%
  dplyr::rename(RR_test_high_disposals = RR_test_high_disposals...14,
                RR_test_low_disposals = RR_test_low_disposals...15,
                sensitivity_baseline_uncalib = sensitivity_baseline_uncalib...16)

#print(prison_receptions_remand_target)

```





### Prison receptions

```{r echo=FALSE}

prison_receptions_target <- botor::s3_read(path_target,
                           readxl::read_excel,
                           range = "receptions!A5:M55") %>%
  dplyr::mutate(date = lubridate::floor_date(as.Date(`Row Labels`), "month"), .keep = "unused")

# print("colnames")
# print(colnames(prison_receptions_target))
# print(prison_receptions_target)

prison_receptions_senband1_target <- prison_receptions_target %>%
  dplyr::select(c("RR_test_high_disposals...2", "RR_test_low_disposals...3", "sensitivity_baseline_uncalib...4", "date")) %>%
  dplyr::rename(RR_test_high_disposals = RR_test_high_disposals...2,
                RR_test_low_disposals = RR_test_low_disposals...3,
                sensitivity_baseline_uncalib = sensitivity_baseline_uncalib...4) #%>%
  #dplyr::mutate(RR_test_high_diff = RR_test_high_disposals - sensitivity_baseline_uncalib,
                #RR_test_low_diff = RR_test_low_disposals - sensitivity_baseline_uncalib)

#print(prison_receptions_senband1_target)


prison_receptions_senband2_target <- prison_receptions_target %>%
  dplyr::select(c("RR_test_high_disposals...5", "RR_test_low_disposals...6", "sensitivity_baseline_uncalib...7", "date")) %>%
  dplyr::rename(RR_test_high_disposals = RR_test_high_disposals...5,
                RR_test_low_disposals = RR_test_low_disposals...6,
                sensitivity_baseline_uncalib = sensitivity_baseline_uncalib...7) #%>%
  #dplyr::mutate(RR_test_high_diff = RR_test_high_disposals - sensitivity_baseline_uncalib,
                #RR_test_low_diff = RR_test_low_disposals - sensitivity_baseline_uncalib)

#print(prison_receptions_senband2_target)


prison_receptions_senband1_target <- prison_receptions_target %>%
  dplyr::select(c("RR_test_high_disposals...8", "RR_test_low_disposals...9", "sensitivity_baseline_uncalib...10", "date")) %>%
  dplyr::rename(RR_test_high_disposals = RR_test_high_disposals...8,
                RR_test_low_disposals = RR_test_low_disposals...9,
                sensitivity_baseline_uncalib = sensitivity_baseline_uncalib...10) #%>%
  #dplyr::mutate(RR_test_high_diff = RR_test_high_disposals - sensitivity_baseline_uncalib,
                #RR_test_low_diff = RR_test_low_disposals - sensitivity_baseline_uncalib)

#print(prison_receptions_senband1_target)


prison_receptions_senband1_target <- prison_receptions_target %>%
  dplyr::select(c("RR_test_high_disposals...11", "RR_test_low_disposals...12", "sensitivity_baseline_uncalib...13", "date")) %>%
  dplyr::rename(RR_test_high_disposals = RR_test_high_disposals...11,
                RR_test_low_disposals = RR_test_low_disposals...12,
                sensitivity_baseline_uncalib = sensitivity_baseline_uncalib...13) #%>%
  #dplyr::mutate(RR_test_high_diff = RR_test_high_disposals - sensitivity_baseline_uncalib,
                #RR_test_low_diff = RR_test_low_disposals - sensitivity_baseline_uncalib)

#print(prison_receptions_senband1_target)
```


### Using same inputs in `prisonflowcast`

Charlotte added monthly number of court disposals as follows:

|Disposal type|  mpg| Central | Low |  High |
|:-----------------|----:|---:|----:|---:|
|cc_effective       | |   6|  160| 110|
|cc_egp    | |   6|  160| 110|
|cc_gp_cracked        | |   4|  108|  93|
|Hornet 4 Drive    | |   6|  258| 110|
|Hornet Sportabout | |   8|  360| 175|
|Valiant           | |   6|  225| 105|

```{r echo=FALSE} 

add_charlotte_disposals <- function(cc_disposals, charlotte_scenario)
  if (charlotte_scenario == "low") {
    cc_disposals <- cc_disposals %>%
      dplyr::mutate(n_disposals_delta = dplyr::if_else(receipt_type_desc == "ind" & route == "effective", 56, n_disposals_delta),
                    n_disposals_delta = dplyr::if_else(receipt_type_desc == "tew" & route == "effective", 37, n_disposals_delta),
                    n_disposals_delta = dplyr::if_else(receipt_type_desc == "ind" & route == "egp", 144, n_disposals_delta),
                    n_disposals_delta = dplyr::if_else(receipt_type_desc == "tew" & route == "egp", 277, n_disposals_delta),
                    n_disposals_delta = dplyr::if_else(receipt_type_desc == "ind" & route == "gp_cracked", 149, n_disposals_delta),
                    n_disposals_delta = dplyr::if_else(receipt_type_desc == "tew" & route == "gp_cracked", 241, n_disposals_delta),
                    n_disposals_delta = dplyr::if_else(receipt_type_desc == "ind" & route == "lgp", 172, n_disposals_delta),
                    n_disposals_delta = dplyr::if_else(receipt_type_desc == "tew" & route == "lgp", 277, n_disposals_delta),
                    n_disposals_delta = dplyr::if_else(receipt_type_desc == "sent" & route == "sent", 1076, n_disposals_delta)
                    )
  } else if (charlotte_scenario == "high") {
    cc_disposals <- cc_disposals %>%
    dplyr::mutate(n_disposals_delta = dplyr::if_else(receipt_type_desc == "ind" & route == "effective", 857, n_disposals_delta),
                  n_disposals_delta = dplyr::if_else(receipt_type_desc == "tew" & route == "effective", 935, n_disposals_delta),
                  n_disposals_delta = dplyr::if_else(receipt_type_desc == "ind" & route == "egp", 566, n_disposals_delta),
                  n_disposals_delta = dplyr::if_else(receipt_type_desc == "tew" & route == "egp", 1140, n_disposals_delta),
                  n_disposals_delta = dplyr::if_else(receipt_type_desc == "ind" & route == "gp_cracked", 544, n_disposals_delta),
                  n_disposals_delta = dplyr::if_else(receipt_type_desc == "tew" & route == "gp_cracked", 948, n_disposals_delta),
                  n_disposals_delta = dplyr::if_else(receipt_type_desc == "ind" & route == "lgp", 838, n_disposals_delta),
                  n_disposals_delta = dplyr::if_else(receipt_type_desc == "tew" & route == "lgp", 1818, n_disposals_delta),
                  n_disposals_delta = dplyr::if_else(receipt_type_desc == "sent" & route == "sent", 3049, n_disposals_delta)
                  )
  }


```

```{r echo=FALSE}

load_central_cc_receipts <- function(police_charges_cc_route_file, start_date, forecast_start_date, forecast_end_date) {
  
  # Load file of ratios from Chun-Yee
  police_charges_cc_route <- load_police_charges_cc_route(police_charges_cc_route_file)
  
  ### Load data from David
  # Suppress message about adding a new column name.
  police_charges_cc_file_central <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_for_ready_reckoner.csv"
  police_charges_cc_central <- suppressMessages(import_s3_file(police_charges_cc_file_central))
  
  police_charges_cc_central <- dplyr::rename(police_charges_cc_central, date = month_year) %>%
    trim_dates(start_date, forecast_start_date, forecast_end_date) %>%
    dplyr::select(-c("...1", "scenario", "forecast_id", "forecast_round")) %>%
    dplyr::mutate(type = dplyr::if_else(type == "app_All", "app_app", type),
                  type = dplyr::if_else(type == "sent_bb_All", "sent_sent", type),
                  type = dplyr::if_else(type == "sent_cs_All", "sent_sent", type))
  
  police_charges_cc_central <- calculate_police_charge_routes(police_charges_cc_route, police_charges_cc_central)
  
}

```


```{r echo=FALSE}

plot_cc_disposals <- function(cc_disposals) {
  
  cc_disposals_united <- tidyr::unite(cc_disposals, receipt_type_route, c(receipt_type_desc, route), sep = " ")
  
  cc_disposals_pivoted <- cc_disposals_united %>%
    dplyr::select(c("date", "receipt_type_route", "n_disposals_delta")) %>%
    tidyr::pivot_wider(
      names_from = date,
      values_from = n_disposals_delta,
      values_fill = 0,
      names_sort = TRUE
    )
  
  x <- as.Date(names(dplyr::select(cc_disposals_pivoted, -c("receipt_type_route"))))
  y <- dplyr::select(cc_disposals_pivoted, -c("receipt_type_route"))
  
  matplot(x,
          t(y),
          type = 'l',
          xlab = "Date",
          main = "Crown Court disposals",
          ylab = "Number of disposals",
          lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
          col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7)
          )
  
  legend("topright",
         inset = 0.02,
         legend = paste0(cc_disposals_pivoted$receipt_type_route),
         lty = c(4,1,1,1,1,1,1,1,3,2,2,2,2,2,2,2),
         col = c(1,1,2,3,4,5,6,7,1,1,2,3,4,5,6,7),
         cex = 0.5
         )
}

```


```{r echo=FALSE}

run_charlotte_scenario <- function(params, cc_receipts_delta_loaded_list, cc_output_loaded, cc_capacity_loaded, mc_disposals_delta_loaded_list, sentencing_rates_loaded,
                         inflows_det_loaded, profiles_det_loaded,
                         nomis_out_delius_in_ratio, profiles_lic, recall_rate_exclPSS, profiles_recall, charlotte_scenario = "low") {
  
  
  cc_receipts_delta  <- load_central_cc_receipts(params$police_charges_cc_route_file, params$start_date, params$forecast_start_date, params$forecast_end_date)
  mc_disposals_delta <- mc_disposals_delta_loaded_list[[params$lever_police_charges_scenario]]
  
  
  
  
  # LEVER: Add (or subtract) sitting days.
  cc_capacity_levered  <- add_cc_sitting_days(cc_capacity_loaded, params$lever_extra_cc_sitting_days, params$lever_extra_cc_sitting_days_impact_date)
  
  # run_courts_module(cc_output_loaded, cc_capacity_levered, cc_receipts_delta, mc_disposals_delta, sentencing_rates_loaded, inflows_det_loaded)
  
  #cc_output <- add_cc_receipts_delta_placeholder(cc_output, 0)   # TO BE REPLACED BY A FUNCTION ADJUSTING THE DELTA RINGFENCED COLUMN
  cc_output <- add_cc_receipts_delta(cc_output_loaded, cc_receipts_delta)
  # print("cc_output")
  # print(cc_output)
  # 
  # Add extra ring-fenced hours to the capacity table.
  cc_capacity <- calculate_hours_ringfenced_delta(cc_output, cc_capacity_levered)
  check_cc_capacity(cc_capacity)
  
  # Join the capacity table with the crown output table and calculate disposals
  # delta for non-ring-fenced cases, assuming current non-ring-fenced disposal
  # case mix.
  ### Get into this format
  ### ADD HERE ###
  cc_disposals <- calculate_cc_disposals(cc_output, cc_capacity)
  print("prisonsreadyreckoner cc_disposals")
  print(dplyr::select(cc_disposals, -c("date")), n = 1000)
  
  # print("cc_disposals")
  # print(cc_disposals)
  
  
  # print("cc_disposals")
  # print(dplyr::select(cc_disposals, -c("n_receipts_delta")), n = 1000)
  # print("mc_disposals_delta")
  # print(mc_disposals_delta)
  
  cc_disposals_central <- cc_disposals
  cc_disposals_charlotte_low <- add_charlotte_disposals(cc_disposals, "low")
  cc_disposals_charlotte_high <- add_charlotte_disposals(cc_disposals, "high")
  
  # print("cc_disposals")
  # plot_cc_disposals(cc_disposals)
  
  print("cc_disposals_central")
  print(cc_disposals_central)
  plot_cc_disposals(cc_disposals_central)
  
  print("cc_disposals_charlotte_low")
  print(cc_disposals_charlotte_low)
  plot_cc_disposals(cc_disposals_charlotte_low)
  
  print("cc_disposals_charlotte_high")
  print(cc_disposals_charlotte_high)
  plot_cc_disposals(cc_disposals_charlotte_high)
  
  # print("cc_disposals")
  # print(dplyr::select(cc_disposals, -c("n_receipts_delta")), n = 1000)
  
  
  # Calculate remand population and determinate inflows from court disposals.
  pop_remand_delta  <- calculate_pop_remand_delta(cc_disposals)
  
  # print("pop_remand_delta")
  # print(pop_remand_delta)
  
  inflows_det_delta <- calculate_inflows_det_delta(cc_disposals, mc_disposals_delta, sentencing_rates_loaded)
  
  # Add delta from court disposals to background inflows.
  inflows_det_adj <- add_inflows_det_delta_courts(inflows_det_loaded, inflows_det_delta)
  
  
  
  
  # LEVER: Add delta from extra inflows lever to other inflows
  inflows_det_levered <- add_inflows_det_delta_lever(inflows_det_adj, params$lever_extra_inflows_det, params$lever_extra_inflows_det_impact_date)
  
  # LEVER: Change distribution of time served by sentence band
  #t0_stretch <- Sys.time()
  profiles_det_levered <- stretch_profiles(profiles_det_loaded, params$lever_profiles_det_stretch_factors, params$lever_profiles_det_stretch_factor_min, params$lever_profiles_det_stretch_factor_max, params$projection_length_months)
  profiles_det_stretch_impact_date_levered <- params$lever_profiles_det_stretch_impact_date
  #print(paste0("stretch_profiles took ", Sys.time() - t0_stretch, " seconds"))
  
  prison_det_outputs <- run_prison_determinate_module(inflows_det_levered, profiles_det_stretch_impact_date_levered, profiles_det_levered)
    outflows_det     <- prison_det_outputs$outflows_det
    pop_det          <- prison_det_outputs$pop_det
  
  month_names        <- names(dplyr::select(inflows_det_loaded, -c("senband")))
  pop_indet          <- run_prison_indeterminate_module(month_names, params$inflows_indet_mean)
  
  
  
  # LEVER: Set recall rates
  recall_rate_levered             <- params$lever_recall_rate
  recall_rate_impact_date_levered <- params$lever_recall_rate_impact_date
  
  pop_recall         <- run_prison_recall_module(outflows_det, nomis_out_delius_in_ratio, profiles_lic,
                                                 recall_rate_exclPSS, recall_rate_levered, recall_rate_impact_date_levered, profiles_recall)
  
  
  pop_scenario <- combine_casetypes(pop_remand_delta, pop_det, pop_indet, pop_recall, "scenario")
  
  
  # # Combine with the baseline and pivot for ease of splitting by gender.
  # pop_combined <- rbind(pop_baseline, pop_scenario) %>%
  #                   tidyr::pivot_longer(-c("run", "casetype", "senband"), names_to = "date", values_to = "population") %>%
  #                   dplyr::mutate(date = as.Date(date))
  # 
  # # Add splits by gender
  # pop_combined <- split_populations_by_gender(pop_combined, gender_splits)
  
}

```


```{r echo=FALSE}

### PUT PARAMS HERE
params <- list()


################################################################################
# Model levers and impact dates.
# Levers are intended for use by a package user. The Shiny app will make use
# of defaults only and set reactive values based on either defaults or inputs
# from the Shiny GUI.
################################################################################

# Number of extra police charges
params$lever_police_charges_scenario           <- "central"

# Number of extra court sitting days per month
params$lever_extra_cc_sitting_days             <- 20000 / 12             # [month^-1]
params$lever_extra_cc_sitting_days_impact_date <- "2024-01-01"

# Number of extra prison receptions per band per month
params$lever_extra_inflows_det                 <- c(senband1 = 0, senband2 = 0, senband3 = 0, senband4 = 0)
params$lever_extra_inflows_det_impact_date     <- "2024-01-01"

# Factors for stretching profiles of time served in prison, broken down by sentence band
params$lever_profiles_det_stretch_factors      <- c(senband1 = 1, senband2 = 1, senband3 = 1, senband4 = 1)
params$lever_profiles_det_stretch_impact_date  <- "2024-01-01"

# Recall
params$lever_recall_rate                       <- signif(c(senband1 = 0.234774346793349, senband2 = 0.1003465003465, senband3 = 0.048357569686712, senband4 = 0.0213297380452349), 3)   # 20230505 - Charlotte Wallace - Updated prison projections .msg
params$lever_recall_rate_impact_date           <- "2024-01-01"



################################################################################
# General parameters.
# General parameters are intended for use by a package user and the Shiny app.
# A user may wish to change these but they will be fixed for individual
# releases of the Shiny app.
################################################################################

# Expected initial dates in various data files. The forecast will start from the
# last consistent date.
params$start_date$police_charges_cc  <- "2022-11-01"    # First month of the forecast. Used for verifying inputs.
params$start_date$police_charges_mc  <- "2022-12-01"
params$start_date$inflows_det        <- "2023-03-31"
params$start_date$recall_rate        <- "2023-03-01"
params$start_date$cc_files           <- "2022-11-01"


params$projection_length_months <- 49         # To March 2027. '20230525 - To Ceri Cooper - Actions from our ready reckoner meeting just now_.msg'


# Police charge parameters
# Magistrates' courts
params$police_charges_mc_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/020623_mags_sensitivity_output.xlsx"
params$police_charges_mc_scenarios <- list(central = "apr23_central",
                                           ramp_12m = "apr23_central_12m",
                                           ramp_36m = "apr23_central_36m",
                                           ramp_48m = "apr23_central_48m"
)
params$police_charges_mc_sheet <- "020623_mags_sensitivity_output-"


# Crown Court
params$police_charges_cc_files <- list(central = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_for_ready_reckoner.csv", # Records the total number of Crown Court receipts used as a baseline in the April 2023 projections. Includes background values from various sources, and an increase in charge numbers over a 24-month period. It has non-zero values throughout.
                                    ramp_12m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_12m_ramp_for_ready_reckoner.csv", # Records how Crown Court receipts would change if police charge numbers were increased over a 12-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
                                    ramp_36m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_36m_ramp_for_ready_reckoner.csv", # Records how Crown Court receipts would change if police charge numbers were increased over a 36-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
                                    ramp_48m = "s3://alpha-app-prisonsreadyreckonerapp/2023-04/April23_mid_pandemic_real_48m_ramp_for_ready_reckoner.csv" # Records how Crown Court receipts would change if police charge numbers were increased over a 48-month period instead of over a 24-month period. Records differences relative to the values in April23_mid_pandemic_real_for_ready_reckoner.csv.
)   # '20230525 - David Verry - RE_ Next steps on the CJS ready reckoner.eml'

# Table from Chun-Yee for converting Crown Court police charge tables
params$police_charges_cc_route_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/routes.csv"   # '20230518 - Chun-yee Cheng - cjst pre-covid route distribution.msg'  


# Crown Court parameters
# Input paths
params$cc_output_file          <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/crown-output-apr23_s4.csv"   # '20230502 - Chun-yee Cheng - RE_ Testing our assumptions with a second Crown Court scenario_.msg'
params$cc_capacity_file        <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/sd_htpsd_adjusted_apr23_s4.csv"   # '20230502 - Chun-yee Cheng - RE_ Testing our assumptions with a second Crown Court scenario_.msg'

# Paths to parameter tables
params$ringfenced_lookup_file  <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/ringfenced-lookup-20230502-shiny-v0.0.0-OFFICIAL.csv"


# Sentencing parameters
# Remand rates. FYI, the Prisons team provided an intercept but this is not
# relevant for marginal changes. The following co-efficients were derived from
# backlog volumes calibrated to match HMCTS outstanding caseload but, for
# simplicity, we are applying them to unadjusted changes in non-ringfenced
# disposal volumes.
params$remand_rates <- tibble::tribble(
  ~receipt_type_desc, ~remand_rate,
  "ind",                     0.580,
  "tew",                     0.277,
  "app",                         0,
  "sent",                        0)   # 20230503 - Charlotte Wallace - RE_ Gender split and remand ratio_.msg

params$sentencing_rates_file  <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/reception-rates-20230502-shiny-v0.0.0-OFFICIAL.csv"


# Prison and licence parameters
params$prison_inflows_file   <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/detailed_apr23_s4_apr23_flat_3m_linear_6m_msim_EDS_change_os_adj_DandS_3m_current_6m_avg_longterm_230426_150555.xlsx"   # '20230505 - Charlotte Wallace - Updated prison projections .msg'
params$profiles_file         <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/profiles-det-20230502-shiny-v0.0.0-OFFICIAL.csv"

# Recall/licence variables
# Put back to previous version so recall rates are fixed values rather than time series
params$recall_file           <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/recall_excl_PSS_output_apr23_s4_apr23_flat_3m_linear_6m_msim_EDS_change_os_adj_DandS_3m_current_6m_avg_longterm_230426_150555.xlsx"   # '20230505 - Charlotte Wallace - Updated prison projections .msg'
#params$licence_times_file    <- "s3://alpha-probation-forecasting-data/Licence/time_spent_on_licence/average_time_on_licence_excl_pss_2023-02-28.csv"   # '20230419 - Danielle Kelly - RE_ Licence and recall parameters_.msg'
params$licence_profiles_file <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/adjusted_license_profile.csv"   # '20230601 - Jordan Carroll - RE_ Your licence profiles_.msg'



# Mean monthly inflow of indeterminate prisoners, taken from OMSQ. We assume
# that indeterminates are never released
params$inflows_indet_mean   <- 299 / 12   # OMSQ Oct-Dec 2022, Table 2.5a, last four quarters


# Gender splits
params$gender_splits_file      <- "s3://alpha-app-prisonsreadyreckonerapp/2023-04/gender-splits-20230502-shiny-v0.0.0-OFFICIAL.csv"

### Set up parameters in correct format ###
params <- format_params(params)

### Load datasets that are fixed throughout the model ###
loaded_datasets_list             <- load_datasets(params)

cc_receipts_delta_loaded_list    <- loaded_datasets_list$cc_receipts_delta_loaded_list
mc_disposals_delta_loaded_list   <- loaded_datasets_list$mc_disposals_delta_loaded_list
cc_output_loaded                 <- loaded_datasets_list$cc_output
cc_capacity_loaded               <- loaded_datasets_list$cc_capacity
sentencing_rates_loaded          <- loaded_datasets_list$sentencing_rates
inflows_det_loaded               <- loaded_datasets_list$inflows_det
profiles_det_loaded              <- loaded_datasets_list$profiles_det
nomis_out_delius_in_ratio        <- loaded_datasets_list$nomis_out_delius_in_ratio
#average_time_on_licence_excl_ps  <- loaded_datasets_list$average_time_on_licence_excl_ps
profiles_lic                     <- loaded_datasets_list$profiles_lic
#licence_profile_adjustments_exc  <- loaded_datasets_list$licence_profile_adjustments_exc
recall_rate_exclPSS              <- loaded_datasets_list$recall_rate_exclPSS
average_time_on_recall           <- loaded_datasets_list$average_time_on_recall
recall_profile_adjustments       <- loaded_datasets_list$recall_profile_adjustments
gender_splits                    <- loaded_datasets_list$gender_splits

# # Defaults not used by the package but made available for the Shiny app.
defaults <- set_defaults(params, recall_rate_exclPSS)
# Rachel to assign reactives to defaults here.


# ### Calculate variables that are fixed throughout the model ###
# # Make profiles of time on licence.
# licence_time    <- multiply_two_named_vectors(average_time_on_licence_excl_ps, licence_profile_adjustments_exc, arguments_to_keep = c("senband1", "senband2", "senband3", "senband4"))
# profiles_lic    <- make_lag_filters(licence_time)

# Make profiles of time on recall.
recall_time     <- multiply_two_named_vectors(average_time_on_recall, recall_profile_adjustments, arguments_to_keep = c("senband1", "senband2", "senband3", "senband4"))
profiles_recall <- make_lag_filters(recall_time)


# print("running baseline")
# baseline <- run_prisonflowcast(params)
# print(baseline)


# Load file of central police charge receipts
central_cc_receipts <- load_central_cc_receipts(params$police_charges_cc_route_file, params$start_date, params$forecast_start_date, params$forecast_end_date)

print("central_cc_receipts")
print(central_cc_receipts)


# Calculate baseline with only original inflows.
print("running baseline")
pop_baseline <- run_baseline(params, inflows_det_loaded, profiles_det_loaded,
                             nomis_out_delius_in_ratio, profiles_lic, recall_rate_exclPSS, profiles_recall)


print("running scenario")
pop_scenario <- run_scenario(params, cc_receipts_delta_loaded_list, cc_output_loaded, cc_capacity_loaded, mc_disposals_delta_loaded_list, sentencing_rates_loaded, inflows_det_loaded, profiles_det_loaded, nomis_out_delius_in_ratio, profiles_lic, recall_rate_exclPSS, profiles_recall)

# Combine with the baseline and pivot for ease of splitting by gender.
pop_combined_scenario <- rbind(pop_baseline, pop_scenario) %>%
                  tidyr::pivot_longer(-c("run", "casetype", "senband"), names_to = "date", values_to = "population") %>%
                  dplyr::mutate(date = as.Date(date))

# Add splits by gender
pop_combined_scenario <- split_populations_by_gender(pop_combined_scenario, gender_splits)


print("running charlotte scenario low")
pop_charlotte_scenario_low <- run_charlotte_scenario(params, cc_receipts_delta_loaded_list, cc_output_loaded, cc_capacity_loaded, mc_disposals_delta_loaded_list, sentencing_rates_loaded, inflows_det_loaded, profiles_det_loaded, nomis_out_delius_in_ratio, profiles_lic, recall_rate_exclPSS, profiles_recall, "low")

# Combine with the baseline and pivot for ease of splitting by gender.
pop_combined_charlotte_scenario_low <- rbind(pop_baseline, pop_charlotte_scenario_low) %>%
                  tidyr::pivot_longer(-c("run", "casetype", "senband"), names_to = "date", values_to = "population") %>%
                  dplyr::mutate(date = as.Date(date))

# Add splits by gender
pop_combined_charlotte_scenario_low <- split_populations_by_gender(pop_combined_charlotte_scenario_low, gender_splits)


print("running charlotte scenario high")
pop_charlotte_scenario_high <- run_charlotte_scenario(params, cc_receipts_delta_loaded_list, cc_output_loaded, cc_capacity_loaded, mc_disposals_delta_loaded_list, sentencing_rates_loaded, inflows_det_loaded, profiles_det_loaded, nomis_out_delius_in_ratio, profiles_lic, recall_rate_exclPSS, profiles_recall, "high")

# Combine with the baseline and pivot for ease of splitting by gender.
pop_combined_charlotte_scenario_high <- rbind(pop_baseline, pop_charlotte_scenario_high) %>%
                  tidyr::pivot_longer(-c("run", "casetype", "senband"), names_to = "date", values_to = "population") %>%
                  dplyr::mutate(date = as.Date(date))

# Add splits by gender
pop_combined_charlotte_scenario_high <- split_populations_by_gender(pop_combined_charlotte_scenario_high, gender_splits)


# print("pop_baseline")
# print(pop_baseline)
# print("pop_charlotte_scenario_low")
# print(pop_charlotte_scenario_low)
# print("pop_charlotte_scenario_high")
# print(pop_charlotte_scenario_high)
# 
# 
# 
# 
# print("pop_combined_scenario")
# dev_plot_population(pop_combined_scenario, "remand", "Remand delta")
# dev_plot_population(pop_combined_scenario, "determinate", "Determinate")
# dev_plot_population(pop_combined_scenario, "indeterminate", "Indeterminate")
# dev_plot_population(pop_combined_scenario, "recall", "Recall")
# 
# print("pop_combined_charlotte_scenario_low")
# dev_plot_population(pop_combined_charlotte_scenario_low, "remand", "Remand delta")
# dev_plot_population(pop_combined_charlotte_scenario_low, "determinate", "Determinate")
# dev_plot_population(pop_combined_charlotte_scenario_low, "indeterminate", "Indeterminate")
# dev_plot_population(pop_combined_charlotte_scenario_low, "recall", "Recall")
# 
# print("pop_combined_charlotte_scenario_high")
# dev_plot_population(pop_combined_charlotte_scenario_high, "remand", "Remand delta")
# dev_plot_population(pop_combined_charlotte_scenario_high, "determinate", "Determinate")
# dev_plot_population(pop_combined_charlotte_scenario_high, "indeterminate", "Indeterminate")
# dev_plot_population(pop_combined_charlotte_scenario_high, "recall", "Recall")


```


NOTE: ignoring remand




