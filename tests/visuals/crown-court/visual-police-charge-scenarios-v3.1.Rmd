---
title: "Police charge comparison. Crown Court disposals."
author: "Brian Burton"
date: "09/11/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

devtools::load_all()

library(magrittr)
source("../../sandbox/dev-params.R")

```

## Aim

Exactly as in v3, except to show that, when disposal rates from scenario files
are used instead of those from the central scenario, outputs that are much
closer to the scenario disposal volumes may be obtained.

### Related tests

* This test is also closely related to visual-crown-court-module-v3.Rmd, which
examined performance of our Crown Court disposals forecasts when sitting days
were increased. The current test differs in that we are changing Crown Court
receipts, not sitting days.

<!-- * This test is also closely related to visual-police-charge-scenarios-v2.Rmd, -->
<!-- which examined performance of our Crown Court receipts calculations when -->
<!-- provided with the the same police scenario files used here. Our benchmark here, -->
<!-- however, includes the impacts of various adjustments to Court receipts made by -->
<!-- the Courts team so deviations exhibited here indicate how much 'accuracy' is -->
<!-- lost in forecasts, which do not have any of these adjustments. -->


## Method

* Given an example police charge court receipts scenario file, call package
  functions to read in the file contents and apply the
  relevant mapping to convert the receipts from a format split by
  `receipt_type_desc` and offence group to one split by `receipt_type_desc` and
  `route`.

* Call further package functions to generate Crown Court disposals. When
forecasting disposals, make sure to use `n_disposals` and `dur_disposals` from
the relevant scenario cc_output file rather than simply these fields from the
central scenario.
  
* Compare disposals of the model with the disposals in the scenario files.
  

```{r include = FALSE}

run_courts_module_lite <- function(cc_receipts_delta_loaded_list, cc_output_loaded, cc_capacity_loaded, scenario, params) {

  cc_receipts_delta <- cc_receipts_delta_loaded_list[[scenario]]

  cc_capacity_levered  <- add_cc_sitting_days(cc_capacity_loaded, 0, params$forecast_start_date)

  cc_output_adj <- add_cc_receipts_delta(cc_output_loaded, cc_receipts_delta)
  
  cc_capacity_adj <- calculate_hours_ringfenced_delta(cc_output_adj, cc_capacity_levered)
  check_cc_capacity(cc_capacity_adj)
  
  cc_disposals_delta_actual <- calculate_cc_disposals_delta(cc_output_adj, cc_capacity_adj)
  
  # Create a 'disposal type', as generated in the package, for plotting
  cc_disposals_delta_actual <- dplyr::mutate(cc_disposals_delta_actual, disposal_type = paste0("cc_", route)) %>%
                                 dplyr::group_by(date, disposal_type) %>%
                                 dplyr::summarise(n_disposals_delta = sum(n_disposals_delta, na.rm = TRUE), .groups = "drop")
  
}


compare_disposals <- function(cc_disposals_delta_actual, target_central, path_target_scenario, params) {

  target_scenario <- import_s3_file(path_target_scenario) %>%
    dplyr::rename(route = "actual_route") %>%
    dplyr::filter(remand == "not remand") %>%
    dplyr::select(c("date", "receipt_type_desc", "route", "n_disposals")) %>%
    trim_dates(params$start_date$cc_files, params$forecast_start_date, params$forecast_end_date)
  
  cc_disposals_delta_expected <- dplyr::left_join(target_central, target_scenario, by = c("date", "receipt_type_desc", "route")) %>%
    dplyr::mutate(n_disposals_delta = n_disposals.y - n_disposals.x, .keep = "unused")

  cc_disposals_delta_expected <- dplyr::mutate(cc_disposals_delta_expected, disposal_type = paste0("cc_", route)) %>%
                                 dplyr::group_by(date, disposal_type) %>%
                                 dplyr::summarise(n_disposals_delta = sum(n_disposals_delta, na.rm = TRUE), .groups = "drop")

  disposal_types <- unique(cc_disposals_delta_expected$disposal_type)
  for (disposal_type in disposal_types)
    plot_disposals_delta(dplyr::filter(cc_disposals_delta_actual, disposal_type == !!disposal_type),
                         dplyr::filter(cc_disposals_delta_expected, disposal_type == !!disposal_type),
                         disposal_type)

}


plot_disposals_delta <- function(cc_disposals_delta_actual, cc_disposals_delta_expected, disposal_type) {
  
  label_act <- paste0("Model, ", disposal_type)
  
  cc_disposals_delta_actual <- dplyr::select(cc_disposals_delta_actual, date, n_disposals_delta) %>%
                                tidyr::pivot_wider(names_from = date,
                                                   values_from = n_disposals_delta,
                                                   values_fill = 0,
                                                   names_sort = TRUE
                              )

  label_exp <- paste0("CJST, ", disposal_type)

  cc_disposals_delta_expected <- dplyr::select(cc_disposals_delta_expected, date, n_disposals_delta) %>%
                                   tidyr::pivot_wider(names_from = date,
                                                      values_from = n_disposals_delta,
                                                      values_fill = 0,
                                                      names_sort = TRUE
                                   )


  cc_disposals_plot <- dplyr::bind_rows(cc_disposals_delta_actual, cc_disposals_delta_expected)

  x <- as.Date(names(cc_disposals_plot))
  y <- cc_disposals_plot
  main <- paste0("Comparison of disposals, ", disposal_type)
  graphics::matplot(x,
          t(y),
          type = 'l',
          xlab = "Date",
          main = main,
          ylab = "Number of disposals",
          lty = c(1, 2),
          col = c(1, 1)
          )
  graphics::legend("topright",
         inset = 0.02,
         legend = c(label_act, label_exp),
         lty = c(1, 2),
         col = c(1, 1)
    )

}

```


```{r include = FALSE}

params <- dev_set_params()
params <- format_params(params)


path_target_central <- params$cc_output_file
path_target_high <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_sep23_v1/model_outputs/adjustments/sensitivity_sd_scaled_v2_231006_0932/crown-output-sep23_s1.csv"   # '20231031 - Bayley Cartmell - Re_ Alternative cc_output tables_.msg'
path_target_low <- "s3://alpha-app-criminal-scenario-tool/developmentFolder/Dev_sep23_v1/model_outputs/adjustments/sensitivity_sd_scaled_v2_231006_0932/crown-output-sep23_s3.csv"   # '20231031 - Bayley Cartmell - Re_ Alternative cc_output tables_.msg'
# path_target_high <- ""   # '20231110 - Bayley Cartmell - Re_ Alternative cc_output tables_.msg'
# path_target_low <- ""   # '20231110 - Bayley Cartmell - Re_ Alternative cc_output tables_.msg'

# Load necessary input data
loaded_datasets_list <- load_datasets(params)
  cc_receipts_delta_loaded_list    <- loaded_datasets_list$cc_receipts_delta_loaded_list
  #mc_disposals_delta_loaded_list   <- loaded_datasets_list$mc_disposals_delta_loaded_list
  cc_output_loaded                 <- loaded_datasets_list$cc_output
  cc_capacity_loaded               <- loaded_datasets_list$cc_capacity
  #sentencing_rates_loaded          <- loaded_datasets_list$sentencing_rates
  #inflows_det_loaded               <- loaded_datasets_list$inflows_det
  #profiles_det_loaded              <- loaded_datasets_list$profiles_det
  #nomis_out_delius_in_ratio        <- loaded_datasets_list$nomis_out_delius_in_ratio
  #profiles_lic                     <- loaded_datasets_list$profiles_lic
  #recall_rate_exclPSS              <- loaded_datasets_list$recall_rate_exclPSS
  #average_time_on_recall           <- loaded_datasets_list$average_time_on_recall
  #recall_profile_adjustments       <- loaded_datasets_list$recall_profile_adjustments
  #gender_splits                    <- loaded_datasets_list$gender_splits

target_central <- import_s3_file(path_target_central) %>%
    dplyr::rename(route = "actual_route") %>%
    dplyr::filter(remand == "not remand") %>%
    dplyr::select(c("date", "receipt_type_desc", "route", "n_disposals")) %>%
    trim_dates(params$start_date$cc_files, params$forecast_start_date, params$forecast_end_date)


```


## Results

### The 'High' scenario.

```{r echo = FALSE}

  cc_disposals_delta_actual_high <- run_courts_module_lite(cc_receipts_delta_loaded_list, cc_output_loaded, cc_capacity_loaded, "sep23_high", params)
  compare_disposals(cc_disposals_delta_actual_high, target_central, path_target_high, params)
```


### The 'Low' scenario

```{r echo = FALSE}
  cc_disposals_delta_actual_low <- run_courts_module_lite(cc_receipts_delta_loaded_list, cc_output_loaded, cc_capacity_loaded, "sep23_low", params)
  compare_disposals(cc_disposals_delta_actual_low, target_central, path_target_low, params)
```

