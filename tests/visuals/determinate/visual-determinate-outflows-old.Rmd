---
title: "Determinate population"
author: "Brian Burton"
date: "27/03/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
```
```{r include=FALSE}
library(magrittr)

# File created on DOM1 by pivoting ad hoc prison flow forecasts from Charlotte
# Wallace.
path_target <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-determinate-population.xlsx"   # This file is created from ad hoc data on DOM1.
# Profiles file prepared with the old FULLSAMPLE (as used by Charlotte to create
# the above)
path_profiles <- "s3://alpha-prison-forecasting-data/prisons-ready-reckoner/prisonsreadyreckoner/test-files/test-determinate-profiles-old-2022-01-01-to-2022-12-31.csv"


plot_series <- function(series, main, ylab) {
  
  
   x <- as.Date(names(dplyr::select(series, -c("senband"))))
   y <- dplyr::select(series, -c("senband"))
   matplot(x,
           t(y),
           'l',
           lty = c(rep(1, 4), rep(2, 4)),
           col = seq(1, 4),
           xlab = "Date", main = main, ylab = ylab)
   legend("topleft",
       inset = 0.02,
       legend = series$senband,
       lty = c(rep(1, 4), rep(2, 4)),
       col = seq(1, 4)
   )
}
```


## Aim

To demonstrate that, when

* our model functions for prison flows are driven with the same inflows as used
in the December 2022 prison projection and
* like the December 2022 projection we use an example, legacy FULLSAMPLE to
generate our sentence length profiles

we get comparable forecasts of prison population.


## Method

Example determinate data from the December 2022 prison projection were obtained
from Charlotte Wallace and pivoted to generate time series of inflows, outflows
and popuation. See
`20230324 - QA - Dec-22 sentencing and receptions prepartion.xlsx` on DOM1.

```{r echo=FALSE}
flows_target <- import_s3_file(path_target)
names(flows_target)[-c(1,2)] <- format(as.Date(as.numeric(names(flows_target)[-c(1,2)]),
                                       origin = "1899-12-30"), "%Y-%m-%d")

inflows_det_target <- dplyr::filter(flows_target, volume=="inflow") %>% dplyr::select(-c("volume"))
pop_det_target    <- dplyr::filter(flows_target, volume=="population") %>% dplyr::select(-c("volume"))

plot_series(inflows_det_target, "Target determinate inflows", expression("Flow [month"^-1*"]"))
```

Equivalent outflows and populations are generated by calling the relevant model
functions using the inflow data above and a FULLSAMPLE version comparable with
that used for the December 2022 projection.


## Results

When driven with the same inputs, our model (solid lines) produces very similar
populations as the target projection (dashed lines).

This indicates that our calculations are correct and the profiles we have
derived are adequate for forecasting prison population.

```{r echo=FALSE}
params <- list()
params$time_served_impact_date <- "2023-04-01"  # An arbitrary date for this illustration.
params$profiles_file <- path_profiles

# The following emulates the sequence in the model with some adjustments for the
# fact that the target inflows does not have any phase ('post_impact' or
# 'pre_impact').
# First get the flow data into a similar form as expected by our model
# functions...
inflows_det_post  <-
  dplyr::filter(flows_target, volume == "inflow") %>% dplyr::select(-c("volume")) %>% dplyr::mutate(phase = "post_impact", .after = 1)
inflows_det_pre            <- inflows_det_post %>% dplyr::mutate(phase = "pre_impact")
inflows_det                <- rbind(inflows_det_post, inflows_det_pre)
coldates_post              <- c(FALSE, FALSE, as.Date(names(inflows_det[-c(1,2)])) >= as.Date(params$time_served_impact_date))
coldates_pre               <- c(FALSE, FALSE, as.Date(names(inflows_det[-c(1,2)])) < as.Date(params$time_served_impact_date))
inflows_det[coldates_post] <- inflows_det[coldates_post] * c(1,1,1,1,0,0,0,0)
inflows_det[coldates_pre]  <- inflows_det[coldates_pre] * c(0,0,0,0,1,1,1,1)

# Now to test our functions...
params$projection_length_months <- ncol(inflows_det) - 2
params$lever_profiles_det_stretch_factor_min <- 0.5
profiles_det  <- load_profiles_det(params$profiles_file, params$projection_length_months, params$lever_profiles_det_stretch_factor_min)

outflows_det  <- mojstockr_mconv(inflows_det, profiles_det, c("senband", "phase"))

inflows_det   <- combine_phases(inflows_det)
outflows_det  <- combine_phases(outflows_det)
pop_det       <- mojstockr_build_stock(inflows_det, outflows_det, c("senband"))

plot_series(rbind(pop_det, pop_det_target), "Model (solid) and target (dashes) determinate populations", "Population")
#plot_series(pop_det, "Model determinate population", "Population")
#plot_series(pop_det_target, "Target determinate population", "Population")
```



