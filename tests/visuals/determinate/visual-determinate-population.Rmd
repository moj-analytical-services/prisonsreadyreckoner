---
title: "Determinate population"
author: "Simon Whitaker"
date: "28/05/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

devtools::load_all()

```

```{r include=FALSE}
library(magrittr)

path_profiles_det <- paste0("s3://alpha-app-prisonsreadyreckonerapp/2023-09/profiles-det-20231016-shiny-v3.0.0-OFFICIAL.csv")
path_flows_det <- "s3://alpha-prison-forecasting-data/prison_demand_model/outputs/prisons/prisons-ready-reckoner-input-files/2023-09/detailed_sep23_s2_flat_3m_linear_6m_sep23_central_scenario_dands_231011_081331-s039-OFFICIAL.xlsx"   # '20231025 - Alex Dickinson - Re_ New files for ready reckoner.msg'
path_flows_det_sheet <- "det_new_recep_discharges_nonAgg"


plot_series <- function(series, main, ylab) {
  
   x <- as.Date(names(dplyr::select(series, -c("senband"))))
   y <- dplyr::select(series, -c("senband"))
   matplot(x,
           t(y),
           'l',
           lty = c(rep(1, 4), rep(2, 4)),
           col = seq(1, 4),
           xlab = "Date", main = main, ylab = ylab)
   legend("topleft",
       inset = 0.02,
       legend = series$senband,
       lty = c(rep(1, 4), rep(2, 4)),
       col = seq(1, 4)
   )
}
```


## Aim

To demonstrate that, when our model functions for prison flows are driven with
the same inputs as used in an example prison projection, we get comparable
forecasts of prison population.


## Method

We are using the same ratios of disposals to prison sentences as those used in the main prison modelling, for consistency.

```{r echo=FALSE}
flows <- import_s3_file(path_flows_det, sheet = path_flows_det_sheet) %>%
  dplyr::mutate(Category = stringr::str_replace_all(.data$Category, c(Band = "senband", EDS = "senband4")))
    
inflows <- flows %>%
  dplyr::select(c("InflowMonth", "Category")) %>%
  dplyr::rename(date = "InflowMonth", senband = "Category") %>%
  dplyr::mutate(date = lubridate::floor_date(.data$date, "month"),
                flow = "inflow") %>%
  dplyr::group_by(.data$date, .data$senband, .data$flow) %>%
  dplyr::summarise(volume = dplyr::n(), .groups = "drop")
    
max_date <- max(inflows$date)
outflows <- flows %>%
  dplyr::select(c("OutflowMonth", "Category")) %>%
  dplyr::rename(date = "OutflowMonth", senband = "Category") %>%
  dplyr::mutate(date = lubridate::floor_date(.data$date, "month"),
                flow = "outflow") %>%
  dplyr::filter(date <= max_date) %>%
  dplyr::group_by(.data$date, .data$senband, .data$flow) %>%
  dplyr::summarise(volume = dplyr::n(), .groups = "drop")
    
flows_agg <- rbind(inflows, outflows) %>%
  tidyr::pivot_wider(names_from = "date", values_from = "volume", values_fill = 0)
    
inflows <- dplyr::filter(flows_agg, .data$flow == "inflow") %>%
  dplyr::select(-c("flow"))
    
outflows <- dplyr::filter(flows_agg, .data$flow == "outflow") %>%
  dplyr::select(-c("flow"))

```

## Results

When replacing the stock-flow modelling with the ratios from the main prisons model, our model is (solid lines) produces very similar populations as the target projection (dashed lines).

This indicates that our inclusion of the ratios is sufficient for forecasting prison population in the ready reckoner.

```{r echo=FALSE}

source("./tests/sandbox/dev-params.R")
params <- dev_set_params()
params <- format_params(params)

profiles_det <- import_s3_file(path_profiles_det)
profiles_det <- dplyr::filter(profiles_det, .data$phase == "pre_impact") %>%
  dplyr::select(-c("phase"))
    
pop_exp <- mojstockr_build_stock(inflows, outflows, c("senband"))
    
outflows_mod <- mojstockr_mconv(inflows, profiles_det, c("senband"))
pop_mod      <- mojstockr_build_stock(inflows, outflows_mod, c("senband"))

model_outputs_grouped <- run_prisonsreadyreckoner(params) %>% dplyr::filter(sex == 'All', casetype == 'determinate', run == 'scenario') %>% dplyr::group_by(run, date, senband) %>% dplyr::summarise(total_pop = sum(population)) %>% dplyr::ungroup() %>% dplyr::select(-run) %>% tidyr::pivot_wider(names_from = 'date', values_from = 'total_pop')

pop_exp_filtered <- pop_exp %>% tidyr::pivot_longer(cols=tidyr::starts_with("20"), names_to = 'date', values_to = 'total_pop') %>% dplyr::filter(date > lubridate::ymd('2023-08-02'), date < lubridate::ymd('2027-09-02')) %>% tidyr::pivot_wider(names_from = 'date', values_from = 'total_pop')

plot_series(rbind(model_outputs_grouped, pop_exp_filtered), "Model (solid) and target (dashes) determinate populations", "Population")
```



