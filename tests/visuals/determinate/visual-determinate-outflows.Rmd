---
title: "Determinate population"
author: "Brian Burton"
date: "09/11/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

devtools::load_all()

```

```{r include=FALSE}
library(magrittr)

# File created on DOM1 by pivoting ad hoc prison flow forecasts from Charlotte
# Wallace.
path_profiles_det <- paste0("s3://alpha-app-prisonsreadyreckonerapp/2023-09/profiles-det-20231016-shiny-v3.0.0-OFFICIAL.csv")
path_flows_det <- "s3://alpha-prison-forecasting-data/prison_demand_model/outputs/prisons/prisons-ready-reckoner-input-files/2023-09/detailed_sep23_s2_flat_3m_linear_6m_sep23_central_scenario_dands_231011_081331-s039-OFFICIAL.xlsx"   # '20231025 - Alex Dickinson - Re_ New files for ready reckoner.msg'
path_flows_det_sheet <- "det_new_recep_discharges_nonAgg"


plot_series <- function(series, main, ylab) {
  
   x <- as.Date(names(dplyr::select(series, -c("senband"))))
   y <- dplyr::select(series, -c("senband"))
   matplot(x,
           t(y),
           'l',
           lty = c(rep(1, 4), rep(2, 4)),
           col = seq(1, 4),
           xlab = "Date", main = main, ylab = ylab)
   legend("topleft",
       inset = 0.02,
       legend = series$senband,
       lty = c(rep(1, 4), rep(2, 4)),
       col = seq(1, 4)
   )
}
```


## Aim

To demonstrate that, when our model functions for prison flows are driven with
the same inflows as used in an example prison projection, we get comparable
forecasts of prison population.


## Method

Example determinate data from the Prisons Team are processed to generate time
series of inflows, outflows and population.

```{r echo=FALSE}
flows <- import_s3_file(path_flows_det, sheet = path_flows_det_sheet) %>%
  dplyr::mutate(Category = stringr::str_replace_all(.data$Category, c(Band = "senband", EDS = "senband4")))
    
inflows <- flows %>%
  dplyr::select(c("InflowMonth", "Category")) %>%
  dplyr::rename(date = "InflowMonth", senband = "Category") %>%
  dplyr::mutate(date = lubridate::floor_date(.data$date, "month"),
                flow = "inflow") %>%
  dplyr::group_by(.data$date, .data$senband, .data$flow) %>%
  dplyr::summarise(volume = dplyr::n(), .groups = "drop")
    
max_date <- max(inflows$date)
outflows <- flows %>%
  dplyr::select(c("OutflowMonth", "Category")) %>%
  dplyr::rename(date = "OutflowMonth", senband = "Category") %>%
  dplyr::mutate(date = lubridate::floor_date(.data$date, "month"),
                flow = "outflow") %>%
  dplyr::filter(date <= max_date) %>%
  dplyr::group_by(.data$date, .data$senband, .data$flow) %>%
  dplyr::summarise(volume = dplyr::n(), .groups = "drop")
    
flows_agg <- rbind(inflows, outflows) %>%
  tidyr::pivot_wider(names_from = "date", values_from = "volume", values_fill = 0)
    
inflows <- dplyr::filter(flows_agg, .data$flow == "inflow") %>%
  dplyr::select(-c("flow"))
    
outflows <- dplyr::filter(flows_agg, .data$flow == "outflow") %>%
  dplyr::select(-c("flow"))

plot_series(inflows, "Target determinate inflows", expression("Flow [month"^-1*"]"))

```

Equivalent outflows and populations are generated by calling the relevant model
functions using the inflow data above and a FULLSAMPLE version comparable with
that used for the inflows provided.


## Results

When driven with the same inputs, our model (solid lines) produces very similar
populations as the target projection (dashed lines).

This indicates that our calculations are correct and the profiles we have
derived are adequate for forecasting prison population.

```{r echo=FALSE}
profiles_det <- import_s3_file(path_profiles_det)
profiles_det <- dplyr::filter(profiles_det, .data$phase == "pre_impact") %>%
  dplyr::select(-c("phase"))
    
pop_exp <- mojstockr_build_stock(inflows, outflows, c("senband"))
    
outflows_mod <- mojstockr_mconv(inflows, profiles_det, c("senband"))
pop_mod      <- mojstockr_build_stock(inflows, outflows_mod, c("senband"))

plot_series(rbind(pop_mod, pop_exp), "Model (solid) and target (dashes) determinate populations", "Population")
```



